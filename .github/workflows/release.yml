name: Release

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    outputs:
      published: ${{ steps.changesets.outputs.published }}
      publishedPackages: ${{ steps.changesets.outputs.publishedPackages }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - name: Create Release Pull Request or Publish
        id: changesets
        uses: changesets/action@v1
        with:
          publish: bun run release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  binaries:
    name: Build Binaries
    needs: release
    if: needs.release.outputs.published == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install

      - name: Get version
        id: version
        run: echo "version=$(jq -r .version package.json)" >> "$GITHUB_OUTPUT"

      - name: Build binaries
        run: |
          bun build --compile --target=bun-linux-x64 index.ts --outfile skygent-linux-x64
          bun build --compile --target=bun-linux-arm64 index.ts --outfile skygent-linux-arm64
          bun build --compile --target=bun-darwin-x64 index.ts --outfile skygent-darwin-x64
          bun build --compile --target=bun-darwin-arm64 index.ts --outfile skygent-darwin-arm64

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          generate_release_notes: true
          files: |
            skygent-linux-x64
            skygent-linux-arm64
            skygent-darwin-x64
            skygent-darwin-arm64

      - name: Update Homebrew formula
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          BASE_URL="https://github.com/mepuka/bsky-cli/releases/download/v${VERSION}"

          SHA_DARWIN_ARM64=$(shasum -a 256 skygent-darwin-arm64 | awk '{print $1}')
          SHA_DARWIN_X64=$(shasum -a 256 skygent-darwin-x64 | awk '{print $1}')
          SHA_LINUX_ARM64=$(shasum -a 256 skygent-linux-arm64 | awk '{print $1}')
          SHA_LINUX_X64=$(shasum -a 256 skygent-linux-x64 | awk '{print $1}')

          cat > /tmp/skygent.rb << FORMULA
          class Skygent < Formula
            desc "Effect-based CLI for Bluesky monitoring, querying, and analytics"
            homepage "https://github.com/mepuka/bsky-cli"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "${BASE_URL}/skygent-darwin-arm64"
                sha256 "${SHA_DARWIN_ARM64}"
              else
                url "${BASE_URL}/skygent-darwin-x64"
                sha256 "${SHA_DARWIN_X64}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "${BASE_URL}/skygent-linux-arm64"
                sha256 "${SHA_LINUX_ARM64}"
              else
                url "${BASE_URL}/skygent-linux-x64"
                sha256 "${SHA_LINUX_X64}"
              end
            end

            def install
              binary = Dir["skygent-*"].first || "skygent"
              bin.install binary => "skygent"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/skygent --version")
            end
          end
          FORMULA

          # Remove leading whitespace from heredoc
          sed -i 's/^          //' /tmp/skygent.rb

          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/mepuka/homebrew-skygent.git /tmp/homebrew-skygent
          cp /tmp/skygent.rb /tmp/homebrew-skygent/Formula/skygent.rb
          cd /tmp/homebrew-skygent
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/skygent.rb
          git commit -m "Update skygent to v${VERSION}"
          git push
