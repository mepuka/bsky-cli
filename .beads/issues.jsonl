{"id":"skygent-bsky-021","title":"CR-18: Document SKYGENT_SYNC env vars in configuration docs","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-28T13:10:49.621353-06:00","updated_at":"2026-01-28T15:49:22.49209-06:00","closed_at":"2026-01-28T15:49:22.49209-06:00","close_reason":"Implemented: docs for config check, sync env vars, and TrendingTopics BskyClient refactor"}
{"id":"skygent-bsky-031","title":"CR-03: Require at least one Engagement threshold","description":"","status":"closed","priority":0,"issue_type":"bug","created_at":"2026-01-28T13:10:46.056795-06:00","updated_at":"2026-01-28T14:41:11.698448-06:00","closed_at":"2026-01-28T14:41:11.698448-06:00","close_reason":"Implemented and reviewed in session 2026-01-28"}
{"id":"skygent-bsky-0x3","title":"Add sync author command to fetch posts by handle/DID","description":"## Background\n\n### Current Limitation\nThe BskyClient in `src/services/bsky-client.ts` currently supports:\n- `getTimeline()` - Fetch authenticated user's home timeline\n- `getFeed(uri)` - Fetch custom/algorithmic feeds by URI\n- `getNotifications()` - Fetch user notifications\n- `getPost(uri)` - Fetch a single post by AT-URI\n\n**Missing capability:** No way to fetch all posts from a specific author.\n\n### Use Cases\n- **Research specific accounts** - Analyze posting patterns, content themes\n- **Track influencers** - Monitor key accounts in your domain\n- **Archive content** - Backup posts from specific users\n- **Build author profiles** - Aggregate posts for display/analysis\n\n---\n\n## Bluesky API Reference\n\n### Endpoint: `app.bsky.feed.getAuthorFeed`\n\n**XRPC Method:** `GET /xrpc/app.bsky.feed.getAuthorFeed`\n\n**Parameters:**\n\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `actor` | string | Yes | - | Handle (e.g., `user.bsky.social`) or DID (e.g., `did:plc:xxx`) |\n| `limit` | integer | No | 50 | Number of posts per request (1-100) |\n| `cursor` | string | No | - | Pagination cursor from previous response |\n| `filter` | string | No | `posts_with_replies` | Content filter (see below) |\n| `includePins` | boolean | No | false | Include pinned posts at top |\n\n**Filter Values:**\n- `posts_with_replies` - All posts and replies (default)\n- `posts_no_replies` - Original posts only, no replies\n- `posts_with_media` - Only posts containing images/video\n- `posts_and_author_threads` - Posts and self-reply threads\n\n**Response:**\n```typescript\n{\n  cursor?: string;\n  feed: FeedViewPost[];  // Same structure as timeline\n}\n```\n\n**Rate Limits:** Standard app view rate limits apply (existing `withRateLimit` pattern handles this).\n\n**Authentication:** Optional - author feeds are public data.\n\n---\n\n## Implementation Scope\n\n### 1. BskyClient Addition (`src/services/bsky-client.ts`)\n\nAdd new method:\n```typescript\ngetAuthorFeed(actor: string, options?: {\n  filter?: 'posts_with_replies' | 'posts_no_replies' | 'posts_with_media' | 'posts_and_author_threads';\n  includePins?: boolean;\n}): Effect\u003cStream\u003cFeedViewPost[]\u003e, BskyError\u003e\n```\n\n- Reuse existing `paginate()` helper for cursor-based pagination\n- Apply existing `withRateLimit` pattern\n- Return paginated stream like `getTimeline()`\n\n### 2. Domain Model (`src/domain/sync.ts`)\n\nAdd to DataSource union:\n```typescript\nexport interface DataSourceAuthor {\n  readonly _tag: \"DataSourceAuthor\";\n  readonly actor: string;  // Handle or DID\n  readonly filter?: AuthorFeedFilter;\n  readonly includePins?: boolean;\n}\n\nexport type AuthorFeedFilter = \n  | \"posts_with_replies\" \n  | \"posts_no_replies\" \n  | \"posts_with_media\" \n  | \"posts_and_author_threads\";\n\n// Update union\nexport type DataSource = \n  | DataSourceTimeline \n  | DataSourceFeed \n  | DataSourceNotifications\n  | DataSourceAuthor;  // \u003c-- Add\n```\n\n### 3. Parser Reuse\n\nThe existing `toRawPostsFromFeed()` function can be reused unchanged - `getAuthorFeed` returns the same `FeedViewPost[]` structure as timeline/feeds.\n\n---\n\n## CLI Integration\n\n### Sync Command\n\n```bash\n# Basic usage - fetch all posts by handle\nsync author alice.bsky.social\n\n# With filter - only posts with media\nsync author alice.bsky.social --filter posts_with_media\n\n# Using DID instead of handle\nsync author did:plc:z72i7hdynmk6r22z27h6tvur\n\n# Include pinned posts\nsync author alice.bsky.social --include-pins\n\n# Combined options\nsync author alice.bsky.social --filter posts_no_replies --include-pins\n```\n\n### Watch Command (Polling Mode)\n\n```bash\n# Poll author's feed for new posts\nwatch author alice.bsky.social\n\n# With filter\nwatch author alice.bsky.social --filter posts_with_media\n```\n\n---\n\n## Technical Considerations\n\n### Handle vs DID Resolution\n- Accept both formats as input (string starting with `did:` vs handle)\n- AT Protocol resolves handles server-side, no client-side resolution needed\n- Store the actor identifier as provided (normalize later if needed)\n\n### Authentication\n- Author feeds are **public data** - authentication optional\n- If authenticated, may see posts from users who blocked you\n- Recommend supporting both authenticated and unauthenticated modes\n\n### Rate Limiting\n- Use existing `withRateLimit` pattern from BskyClient\n- Same limits as timeline/feed endpoints\n- Exponential backoff on 429 responses\n\n### Pagination\n- Same cursor-based pattern as timeline\n- Reuse `paginate()` helper function\n- Default batch size of 50 (API maximum: 100)\n\n### Error Handling\n- `ActorNotFound` - Invalid handle or DID\n- `BlockedActor` - Authenticated user is blocked\n- Network errors - Existing retry logic applies\n\n---\n\n## Acceptance Criteria\n\n- [ ] `getAuthorFeed(actor, options?)` method added to BskyClient\n- [ ] Method returns `Effect\u003cStream\u003cFeedViewPost[]\u003e, BskyError\u003e`\n- [ ] DataSourceAuthor interface added to sync.ts domain model\n- [ ] DataSource union updated to include DataSourceAuthor\n- [ ] `sync author \u003chandle-or-did\u003e` command implemented\n- [ ] `--filter` option works with all four API filter values\n- [ ] `--include-pins` flag works correctly\n- [ ] `watch author \u003chandle\u003e` polling mode works\n- [ ] Both handle format (`user.bsky.social`) and DID format (`did:plc:xxx`) accepted\n- [ ] Unit tests for BskyClient.getAuthorFeed\n- [ ] Integration test with real Bluesky API\n- [ ] Error handling for invalid actor identifiers\n\n---\n\n## Related Files\n\n- `src/services/bsky-client.ts` - Add getAuthorFeed method\n- `src/domain/sync.ts` - Add DataSourceAuthor\n- `src/commands/sync.ts` - Add author subcommand\n- `src/commands/watch.ts` - Add author polling support","status":"open","priority":1,"issue_type":"feature","created_at":"2026-01-27T10:38:55.673961-06:00","updated_at":"2026-01-27T10:39:25.726746-06:00"}
{"id":"skygent-bsky-17v","title":"CR-08: Handle regex should accept uppercase handles","description":"","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-28T13:10:48.136164-06:00","updated_at":"2026-01-28T15:44:28.793969-06:00","closed_at":"2026-01-28T15:44:28.793969-06:00","close_reason":"Implemented: Handle regex i-flag, NonNegativeInt limit, CLI limit validation"}
{"id":"skygent-bsky-1at","title":"Wire derivation layers into CLI with proper dependencies","description":"**Plan Reference**: /Users/pooks/.claude/plans/cosmic-popping-cake.md - Phase 1, Layers section (lines 504-537)\n\n## Goal\nAdd derivation services to CliLive layer with proper dependency wiring. Ensure FilterRuntime has all required effectful service dependencies.\n\n## Pre-Implementation Research (CRITICAL)\n\n### 1. Review Existing Code\n- Read src/cli/layers.ts - understand current layer composition\n- Read src/services/filter-runtime.ts - understand runtime dependencies\n- Study Layer.provideMerge vs Layer.provide patterns\n- Review existing runtimeLayer wiring (lines 81-104 in current layers.ts)\n\n### 2. Effect Documentation Research\nUse effect-docs MCP extensively:\n```\neffect-docs search \"Layer.provide\"\neffect-docs search \"Layer.provideMerge\"\neffect-docs search \"Layer.mergeAll\"\neffect-docs search \"layer composition\"\neffect-docs search \"service dependencies\"\n```\n\nStudy deeply:\n- Layer.provide vs Layer.provideMerge (critical difference!)\n- Layer.mergeAll for multiple layers\n- Dependency resolution order\n- Circular dependency detection\n\n### 3. Review Effect Source (CRITICAL)\nStudy Layer implementation:\n- How provide chains dependencies\n- How merge combines layers\n- When to use provide vs provideMerge\n- Error messages for missing dependencies\n\n## Implementation\n\n### File: src/cli/layers.ts (modify)\n\nAdd three new layers following existing patterns:\n\n```typescript\n// ViewCheckpointStore depends on KeyValueStore (via storageLayer)\nconst viewCheckpointLayer = ViewCheckpointStore.layer.pipe(\n  Layer.provideMerge(storageLayer)\n);\n\n// LineageStore depends on KeyValueStore (via storageLayer)\nconst lineageLayer = LineageStore.layer.pipe(\n  Layer.provideMerge(storageLayer)\n);\n\n// DerivationEngine has MANY dependencies - wire carefully\nconst derivationLayer = DerivationEngine.layer.pipe(\n  Layer.provideMerge(eventLogLayer),      // StoreEventLog\n  Layer.provideMerge(writerLayer),        // StoreWriter\n  Layer.provideMerge(indexLayer),         // StoreIndex\n  Layer.provideMerge(FilterCompiler.layer),\n  Layer.provideMerge(runtimeLayer),       // FilterRuntime with LLM/Link/Trending layers\n  Layer.provideMerge(viewCheckpointLayer), // ViewCheckpointStore\n  Layer.provideMerge(lineageLayer)        // LineageStore\n);\n\n// DerivationValidator needs checkpoint store, event log, store manager\nconst derivationValidatorLayer = DerivationValidator.layer.pipe(\n  Layer.provideMerge(viewCheckpointLayer),\n  Layer.provideMerge(eventLogLayer),\n  Layer.provideMerge(managerLayer)\n);\n\n// Add to CliLive exports\nexport const CliLive = Layer.mergeAll(\n  // ... existing layers\n  viewCheckpointLayer,\n  lineageLayer,\n  derivationLayer,\n  derivationValidatorLayer\n);\n```\n\n## Critical Considerations\n- FilterRuntime already has llmDecisionLayer + linkValidatorLayer + trendingTopicsLayer wired (see existing runtimeLayer)\n- Use Layer.provideMerge for all dependencies (NOT Layer.provide)\n- Order matters: dependencies must be provided before dependents\n- DerivationEngine needs ALL services it yields*\n- Check compilation errors for missing dependencies\n\n## Acceptance Criteria\n- [ ] All layers compile without errors\n- [ ] No missing dependency errors at runtime\n- [ ] viewCheckpointLayer wired correctly\n- [ ] lineageLayer wired correctly\n- [ ] derivationLayer wired with all 7 dependencies\n- [ ] derivationValidatorLayer wired with 3 dependencies\n- [ ] All layers added to CliLive\n- [ ] No circular dependencies\n- [ ] Follows existing layer patterns\n\n## Verification\n```bash\n# Test compilation\nbun run build\n\n# Test runtime (should not error about missing services)\nskygent derive --help\n\n# Test full pipeline\nskygent derive test-source test-target --filter-json '{\"_tag\":\"All\"}'\n# Should not error with \"service not found\"\n```\n\n## Related\n- Parent: #1\n- Depends on: skygent-bsky-293, skygent-bsky-hm1, skygent-bsky-ijd, skygent-bsky-5h2\n- Blocks: skygent-bsky testing","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-26T14:21:44.333964-06:00","updated_at":"2026-01-26T15:50:13.170743-06:00","closed_at":"2026-01-26T15:50:13.170743-06:00","close_reason":"Layer wiring completed during CLI commands implementation (skygent-bsky-5h2)","dependencies":[{"issue_id":"skygent-bsky-1at","depends_on_id":"skygent-bsky-5h2","type":"blocks","created_at":"2026-01-26T14:22:49.790236-06:00","created_by":"daemon"},{"issue_id":"skygent-bsky-1at","depends_on_id":"skygent-bsky-hm1","type":"blocks","created_at":"2026-01-26T14:22:49.913018-06:00","created_by":"daemon"}]}
{"id":"skygent-bsky-1de","title":"CR-36: Remove or connect writeJson pretty parameter","description":"","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-28T13:10:48.642876-06:00","updated_at":"2026-01-28T16:37:08.409235-06:00","closed_at":"2026-01-28T16:37:08.409235-06:00","close_reason":"writeJson pretty parameter is functional and wired up"}
{"id":"skygent-bsky-21t","title":"CR-30: Consider consistent store name arg/option pattern","description":"","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-28T13:10:47.654794-06:00","updated_at":"2026-01-28T13:10:47.654794-06:00"}
{"id":"skygent-bsky-293","title":"Implement ViewCheckpointStore and LineageStore services","description":"**Plan Reference**: /Users/pooks/.claude/plans/cosmic-popping-cake.md - Phase 2, sections 3.1\n\n## Goal\nCreate KV-backed stores for persisting DerivationCheckpoint and StoreLineage. Follow existing service patterns.\n\n## Pre-Implementation Research\n\n### 1. Review Existing Code\n- Read src/services/store-manager.ts - understand KV service pattern\n- Read src/services/sync-checkpoint-store.ts (if exists) - checkpoint pattern\n- Study Context.Tag service definition pattern\n- Review Layer.effect composition\n\n### 2. Effect Documentation Research\nUse effect-docs MCP:\n```\neffect-docs search \"Context.Tag\"\neffect-docs search \"Layer composition\"\neffect-docs search \"service dependencies\"\neffect-docs search \"Effect.fn\"\n```\n\nStudy:\n- Context.Tag for service definition\n- Layer.effect for service implementation\n- Service dependency injection\n- Effect.fn() for traced operations\n\n### 3. Review Effect Source\nCheck Context and Layer implementations:\n- Tag creation patterns\n- Layer dependency resolution\n- Service lifetime management\n\n## Implementation\n\n### File: src/services/view-checkpoint-store.ts (new)\n```typescript\nimport { Context, Effect, Layer, Option } from \"effect\";\nimport { KeyValueStore } from \"@effect/platform\";\nimport { DerivationCheckpoint } from \"../domain/derivation.js\";\nimport { StoreName } from \"../domain/primitives.js\";\nimport { StoreIoError } from \"../domain/errors.js\";\n\nconst checkpointKey = (viewName: StoreName, sourceName: StoreName) =\u003e\n  `stores/${viewName}/checkpoints/derivation/${sourceName}`;\n\nexport class ViewCheckpointStore extends Context.Tag(\"@skygent/ViewCheckpointStore\")\u003c\n  ViewCheckpointStore,\n  {\n    readonly load: (\n      viewName: StoreName,\n      sourceName: StoreName\n    ) =\u003e Effect.Effect\u003cOption.Option\u003cDerivationCheckpoint\u003e, StoreIoError\u003e;\n    readonly save: (\n      checkpoint: DerivationCheckpoint\n    ) =\u003e Effect.Effect\u003cvoid, StoreIoError\u003e;\n  }\n\u003e() {\n  static readonly layer = Layer.effect(\n    ViewCheckpointStore,\n    Effect.gen(function* () {\n      const kv = yield* KeyValueStore.KeyValueStore;\n      const checkpoints = kv.forSchema(DerivationCheckpoint);\n\n      const load = Effect.fn(\"ViewCheckpointStore.load\")(\n        (viewName: StoreName, sourceName: StoreName) =\u003e\n          checkpoints.get(checkpointKey(viewName, sourceName)).pipe(\n            Effect.mapError((e) =\u003e StoreIoError.make({ ... }))\n          )\n      );\n\n      const save = Effect.fn(\"ViewCheckpointStore.save\")(\n        (checkpoint: DerivationCheckpoint) =\u003e\n          checkpoints.set(\n            checkpointKey(checkpoint.viewName, checkpoint.sourceStore),\n            checkpoint\n          ).pipe(\n            Effect.mapError((e) =\u003e StoreIoError.make({ ... }))\n          )\n      );\n\n      return ViewCheckpointStore.of({ load, save });\n    })\n  );\n}\n```\n\n### File: src/services/lineage-store.ts (new)\nSimilar pattern for StoreLineage - see plan section 2.2\n\n## Critical Considerations\n- Use Effect.fn() for all operations (tracing)\n- Map KV errors to StoreIoError\n- Use forSchema for type-safe KV access\n- Follow naming conventions: service-name.method\n\n## Acceptance Criteria\n- [ ] ViewCheckpointStore compiles without errors\n- [ ] LineageStore compiles without errors\n- [ ] Both services use Context.Tag pattern\n- [ ] Layer.effect properly wires dependencies\n- [ ] Effect.fn() used for all operations\n- [ ] Errors mapped to domain types\n- [ ] No unsafe Effect patterns\n\n## Verification\n```bash\n# Test service creation\nbun test tests/services/view-checkpoint-store.test.ts\nbun test tests/services/lineage-store.test.ts\n```\n\n## Related\n- Parent: #1\n- Depends on: skygent-bsky-9ed (domain types)\n- Blocks: skygent-bsky DerivationEngine","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-26T14:18:25.132359-06:00","updated_at":"2026-01-26T14:45:03.220226-06:00","closed_at":"2026-01-26T14:45:03.220226-06:00","close_reason":"Closed","dependencies":[{"issue_id":"skygent-bsky-293","depends_on_id":"skygent-bsky-9ed","type":"blocks","created_at":"2026-01-26T14:22:49.15138-06:00","created_by":"daemon"}]}
{"id":"skygent-bsky-2oo","title":"CR-19: TrendingTopics should use BskyClient not own AtpAgent","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-28T13:10:49.758457-06:00","updated_at":"2026-01-28T15:49:22.49257-06:00","closed_at":"2026-01-28T15:49:22.49257-06:00","close_reason":"Implemented: docs for config check, sync env vars, and TrendingTopics BskyClient refactor"}
{"id":"skygent-bsky-357","title":"Handle schema too restrictive - rejects valid long bridged handles","description":"","status":"open","priority":2,"issue_type":"bug","created_at":"2026-01-29T17:53:35.088603-06:00","updated_at":"2026-01-29T17:53:35.088603-06:00"}
{"id":"skygent-bsky-36e","title":"Add sync likes command for engagement attribution","description":"## Background\n\nCurrently likes are only stored as metrics on posts (likeCount). There is no way to see WHO liked a post, nor what posts a specific user has liked.\n\n**Current limitation:** Only store like counts, not individual likes\n\n**Questions we cannot answer today:**\n- Who liked this post?\n- What has this user liked?\n\n**Use cases this enables:**\n- Engagement analysis (who are my most engaged followers?)\n- Audience understanding (what do my likers also like?)\n- Recommendation systems (users who liked X also liked Y)\n\n---\n\n## Bluesky API Reference\n\n### Endpoint: `app.bsky.feed.getLikes`\n**Purpose:** Retrieve who liked a specific post\n\n**Parameters:**\n- `uri` (required): AT-URI of the post\n- `cid` (optional): CID of the post version\n- `limit`: Max results per page (default: 50, max: 100)\n- `cursor`: Pagination cursor\n\n**Returns:**\n```typescript\n{\n  uri: string\n  cid?: string\n  cursor?: string\n  likes: Array\u003c{\n    actor: ProfileView\n    createdAt: string\n    indexedAt: string\n  }\u003e\n}\n```\n\n### Endpoint: `app.bsky.feed.getActorLikes`\n**Purpose:** Retrieve posts a user has liked\n\n**Parameters:**\n- `actor` (required): Handle or DID of the user\n- `limit`: Max results per page (default: 50, max: 100)\n- `cursor`: Pagination cursor\n\n**Returns:**\n```typescript\n{\n  cursor?: string\n  feed: FeedViewPost[]  // Array of liked posts with full post data\n}\n```\n\n---\n\n## Domain Model Design\n\n### New `Like` class\n\n```typescript\ninterface Like {\n  uri: string           // AT-URI of the like record itself\n  subject: PostUri      // URI of the post that was liked\n  actor: Did            // DID of the user who liked\n  createdAt: Date       // When the like was created\n  indexedAt?: Date      // When we indexed it\n}\n```\n\n### Events\n\n- `LikeCreated`: { like: Like }\n- `LikeDeleted`: { uri: string, subject: PostUri, actor: Did }\n\nLikes should be stored separately from posts for efficient querying in both directions.\n\n---\n\n## Storage Design\n\n### Primary Storage\n- `likes/by-post/{uri-encoded}` - All likes on a specific post\n- `likes/by-actor/{did}` - All posts a specific actor has liked\n\n### Edge Records\n- `likes/edges/{did}/{uri-encoded}` - Individual like records for deduplication\n\n### Index Structure\n```\nlikes/\n├── by-post/\n│   └── {post-uri-encoded}/\n│       └── {like-uri}.json\n├── by-actor/\n│   └── {did}/\n│       └── {like-uri}.json\n└── edges/\n    └── {actor-did}/\n        └── {post-uri-encoded}.json\n```\n\n---\n\n## CLI Integration\n\n### New Commands\n\n**Sync commands:**\n```bash\n# Fetch who liked a specific post\nsync likes \u003cpost-uri\u003e\nsync likes at://did:plc:xyz/app.bsky.feed.post/abc123\n\n# Fetch what posts a user has liked  \nsync actor-likes \u003chandle\u003e\nsync actor-likes alice.bsky.social\n```\n\n**Query commands:**\n```bash\n# Query stored likes on a post\nquery likes \u003cpost-uri\u003e\n\n# Query what a user has liked\nquery actor-likes \u003chandle\u003e\n```\n\n### Options\n- `--limit=N`: Maximum likes to fetch (for pagination)\n- `--all`: Fetch all pages (careful with rate limits)\n- `--since=\u003cdate\u003e`: Only likes after this date\n\n---\n\n## Technical Considerations\n\n### Scale\n- Popular posts can have **millions of likes**\n- Pagination is critical - never try to fetch all at once\n- Consider incremental sync (only new likes since last sync)\n\n### Rate Limiting\n- Bluesky has rate limits on API calls\n- Implement backoff and respect rate limit headers\n- Consider parallel fetching with controlled concurrency\n\n### Data Differences\n- `getLikes` returns `ProfileView` for actors (rich profile data)\n- `getActorLikes` returns full `FeedViewPost` (includes the liked post)\n- May want to store the embedded profile/post data as well\n\n### Bidirectional Queries\nStore indexes in both directions to efficiently answer:\n- \"Who liked post X?\" → by-post index\n- \"What did user Y like?\" → by-actor index\n\n---\n\n## Acceptance Criteria\n\n- [ ] Like domain model created (Like class, LikeCreated/LikeDeleted events)\n- [ ] LikeStore service implemented with Effect patterns\n- [ ] `sync likes \u003curi\u003e` fetches and stores who liked a post\n- [ ] `sync actor-likes \u003chandle\u003e` fetches and stores what a user liked\n- [ ] Like indexes work in both directions\n- [ ] `query likes \u003curi\u003e` returns stored likes on a post\n- [ ] `query actor-likes \u003chandle\u003e` returns posts a user has liked\n- [ ] Pagination works correctly for large result sets\n- [ ] Rate limiting is respected\n\n---\n\n## Dependencies\n\n- Depends on existing Post domain model for subject references\n- Depends on existing Actor/Profile handling for liker data\n- May benefit from generic pagination utilities\n\n## Related\n\n- sync posts command (similar pattern)\n- sync followers command (related engagement data)","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-27T10:42:06.926831-06:00","updated_at":"2026-01-27T10:42:33.101385-06:00"}
{"id":"skygent-bsky-372","title":"Cross-store topology and author discovery","description":"Store overlap analysis, author discovery via graph traversal, derivation lineage visualization. Combines Bluesky API + store data. See GitHub issue.","status":"open","priority":2,"issue_type":"feature","created_at":"2026-02-01T12:40:55.520554-06:00","updated_at":"2026-02-01T12:40:55.520554-06:00"}
{"id":"skygent-bsky-3vr","title":"Add engagement-based sorting to query command","description":"--sort by-likes/by-engagement on query. Indexes exist, need query planner + CLI changes. See GitHub issue.","status":"open","priority":2,"issue_type":"feature","created_at":"2026-02-01T12:24:07.018292-06:00","updated_at":"2026-02-01T12:24:07.018292-06:00"}
{"id":"skygent-bsky-40a","title":"Store-centric interaction network analysis","description":"Build directed interaction graphs from store post data (replies, quotes, mentions). New InteractionGraphService using Effect Graph.directed. See GitHub issue.","status":"open","priority":2,"issue_type":"feature","created_at":"2026-02-01T12:32:04.406188-06:00","updated_at":"2026-02-01T12:32:04.406188-06:00"}
{"id":"skygent-bsky-44c","title":"Add unit and integration tests for store derivation","description":"**Plan Reference**: /Users/pooks/.claude/plans/cosmic-popping-cake.md - Testing Strategy section (lines 625-640)\n\n## Goal\nComprehensive test coverage for derivation: unit tests for services, integration tests for end-to-end workflows, property tests for invariants.\n\n## Pre-Implementation Research\n\n### 1. Review Existing Code\n- Read tests/services/*.test.ts - understand test patterns\n- Read tests/integration/*.test.ts - understand integration test structure\n- Study bun:test API (describe, test, expect)\n- Review test layer composition patterns\n\n### 2. Effect Documentation Research\nUse effect-docs MCP:\n```\neffect-docs search \"Effect.runPromise\"\neffect-docs search \"Layer.provide testing\"\neffect-docs search \"test fixtures\"\n```\n\nStudy:\n- Running Effect in tests\n- Test layer composition\n- Mock services\n- Effect.gen in tests\n\n### 3. Review Bun Test Docs\nStudy bun:test:\n- async test patterns\n- expect assertions\n- describe/test structure\n\n## Implementation\n\n### File: tests/services/derivation-engine.test.ts (new)\n\n```typescript\nimport { describe, test, expect } from \"bun:test\";\nimport { Effect, Layer } from \"effect\";\nimport { DerivationEngine } from \"../../src/services/derivation-engine.js\";\n\ndescribe(\"DerivationEngine\", () =\u003e {\n  test(\"derives filtered posts from source\", async () =\u003e {\n    // Create test stores with mock data\n    // Apply Hashtag filter\n    // Verify target has only matching posts\n  });\n\n  test(\"propagates ALL PostDelete events unfiltered\", async () =\u003e {\n    // Create source with mixed PostUpsert and PostDelete\n    // Derive with Hashtag filter\n    // Verify ALL deletes in target (even non-matching hashtags)\n    // Verify only matching PostUpsert in target\n  });\n\n  test(\"idempotence: derive twice yields same result\", async () =\u003e {\n    // Derive source to target\n    // Derive again\n    // Verify eventsProcessed = 0 on second run\n    // Verify target has same posts\n  });\n\n  test(\"EventTime mode rejects effectful filters\", async () =\u003e {\n    // Try derive with Llm filter in EventTime mode\n    // Expect DerivationError\n  });\n\n  test(\"DeriveTime mode accepts effectful filters\", async () =\u003e {\n    // Derive with Llm filter in DeriveTime mode\n    // Should succeed (even if LLM calls fail, they're caught)\n  });\n\n  test(\"checkpoint enables incremental derivation\", async () =\u003e {\n    // Derive 100 posts\n    // Add 10 more to source\n    // Derive again\n    // Verify eventsProcessed = 10 (not 110)\n  });\n\n  test(\"filter change invalidates checkpoint\", async () =\u003e {\n    // Derive with Hashtag #tech\n    // Derive with Hashtag #ai (different filter)\n    // Should error without --reset\n  });\n\n  test(\"localeCompare used for EventId filtering\", async () =\u003e {\n    // Create checkpoint with lastSourceEventId\n    // Verify stream filters using localeCompare\n    // Test with ULID edge cases\n  });\n});\n```\n\n### File: tests/integration/derive-full.test.ts (new)\n\n```typescript\nimport { describe, test, expect } from \"bun:test\";\n\ndescribe(\"Store Derivation End-to-End\", () =\u003e {\n  test(\"derive creates filtered store\", async () =\u003e {\n    // Sync timeline to source store\n    // Run: skygent derive source target --filter-json {...}\n    // Query target\n    // Verify subset of source\n  });\n\n  test(\"delete propagation maintains consistency\", async () =\u003e {\n    // Create source with posts\n    // Manually add PostDelete event\n    // Derive to target\n    // Verify PostDelete in target event log\n    // Verify deleted URI not in target index\n  });\n\n  test(\"view status detects staleness\", async () =\u003e {\n    // Derive source to target\n    // Run: skygent view status target source\n    // Expect: \"ready\"\n    // Add events to source\n    // Run: skygent view status target source\n    // Expect: \"stale\"\n  });\n\n  test(\"--reset clears and rebuilds\", async () =\u003e {\n    // Derive with filter A\n    // Derive with filter B --reset --yes\n    // Verify old posts cleared\n    // Verify new filter applied\n  });\n});\n```\n\n### Property Tests\n\n```typescript\ndescribe(\"Derivation Invariants\", () =\u003e {\n  test(\"count invariant: processed = matched + skipped\", async () =\u003e {\n    // Property: eventsProcessed = eventsMatched + eventsSkipped\n    // Test with random filters and post sets\n  });\n\n  test(\"idempotence: derive(S,T,F) twice = derive(S,T,F) once\", async () =\u003e {\n    // Run derivation twice\n    // Compare final states\n    // Should be identical\n  });\n});\n```\n\n## Critical Considerations\n- Use Effect.runPromise for async tests\n- Provide test layers (mock stores if needed)\n- Test error cases (missing stores, invalid filters)\n- Verify PostDelete propagation explicitly\n- Test ULID localeCompare edge cases\n\n## Acceptance Criteria\n- [ ] DerivationEngine unit tests pass\n- [ ] Integration tests pass\n- [ ] Property tests pass\n- [ ] PostDelete propagation verified\n- [ ] Idempotence verified\n- [ ] EventTime/DeriveTime modes tested\n- [ ] Checkpoint incremental derivation tested\n- [ ] Filter change detection tested\n- [ ] 85%+ code coverage\n\n## Verification\n```bash\n# Run all tests\nbun test\n\n# Run specific tests\nbun test tests/services/derivation-engine.test.ts\nbun test tests/integration/derive-full.test.ts\n\n# Coverage\nbun test --coverage\n```\n\n## Related\n- Parent: #1\n- Depends on: All previous issues (9ed, uej, 293, hm1, ijd, 5h2, 1at)\n- Blocks: Manual QA and release","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-26T14:22:18.052925-06:00","updated_at":"2026-01-26T15:54:02.660251-06:00","closed_at":"2026-01-26T15:54:02.660251-06:00","close_reason":"Comprehensive test coverage completed: 10 DerivationEngine tests + 6 DerivationValidator tests. 93/96 tests passing overall. Core derivation functionality fully tested.","dependencies":[{"issue_id":"skygent-bsky-44c","depends_on_id":"skygent-bsky-1at","type":"blocks","created_at":"2026-01-26T14:22:50.036921-06:00","created_by":"daemon"}]}
{"id":"skygent-bsky-48u","title":"Enrich store stats and sync response with timestamps and richer metadata","description":"Store stats (`store stats`) should include:\n- First/last post timestamps (full ISO, not just date)\n- Possibly more aggregate metadata (e.g. date histogram, posts/hour)\n\nSync response should include richer metadata:\n- Time range of ingested posts\n- Duration of sync\n- Posts per second throughput\n\nSeparately: consider architectural enhancement for global post-level content hashing/dedup across stores (needs design discussion — content-addressable post cache, per-store vs global dedup strategy).","status":"open","priority":3,"issue_type":"feature","created_at":"2026-01-31T22:50:27.644523-06:00","updated_at":"2026-01-31T22:50:27.644523-06:00"}
{"id":"skygent-bsky-4y7","title":"CR-10: Add missing barrel exports to domain/index.ts","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-28T13:10:48.486238-06:00","updated_at":"2026-01-28T15:47:06.420189-06:00","closed_at":"2026-01-28T15:47:06.420189-06:00","close_reason":"Implemented: paginated query streaming and batched rebuild transactions"}
{"id":"skygent-bsky-5h2","title":"Add derive and view CLI commands with filter change detection","description":"**Plan Reference**: /Users/pooks/.claude/plans/cosmic-popping-cake.md - Phase 1, sections 2.1, 2.2, 2.3, 2.4 (lines 439-500)\n\n## Goal\nImplement skygent derive and skygent view commands with proper validation, error messages, and user confirmation prompts.\n\n## Pre-Implementation Research\n\n### 1. Review Existing Code (CRITICAL)\n- Read src/cli/sync.ts - understand command structure\n- Read src/cli/query.ts - understand Options and Args patterns\n- Read src/cli/store.ts - understand store show output\n- Read src/cli/errors.ts - understand CliInputError pattern\n- Study @effect/cli command composition\n\n### 2. Effect Documentation Research\nUse effect-docs MCP:\n```\neffect-docs search \"@effect/cli Command\"\neffect-docs search \"Options.text\"\neffect-docs search \"Options.choice\"\neffect-docs search \"Options.boolean\"\neffect-docs search \"Args.text\"\n```\n\nStudy:\n- Command.make patterns\n- Options validation\n- Args with Schema\n- Command composition\n\n### 3. Review @effect/cli Source\nCheck Command implementation:\n- withDescription pattern\n- withExamples usage\n- Subcommand composition\n\n## Implementation\n\n### File: src/cli/derive.ts (new)\nKey sections from plan lines 450-482:\n\n```typescript\nconst filterOption = Options.text(\"filter-json\").pipe(Options.optional);\nconst modeOption = Options.choice(\"mode\", [\"event-time\", \"derive-time\"]).pipe(\n  Options.withDefault(\"event-time\" as const)\n);\nconst resetFlag = Options.boolean(\"reset\");\nconst yesFlag = Options.boolean(\"yes\").pipe(Options.withAlias(\"y\"));\n\n// EventTime guard for effectful filters\nif (mode === \"event-time\" \u0026\u0026 isEffectfulFilter(filterExpr)) {\n  return yield* CliInputError.make({\n    message: \"EventTime mode does not allow Llm/Trending/HasValidLinks. Use --mode derive-time.\",\n    cause: filterExpr\n  });\n}\n\n// Reset requires --yes\nif (reset \u0026\u0026 !yes) {\n  return yield* CliInputError.make({\n    message: \"--reset is destructive. Re-run with --yes to confirm.\",\n    cause: \"reset-without-yes\"\n  });\n}\n\n// Filter change detection\nconst checkpointOption = yield* checkpoints.load(targetRef.name, sourceRef.name);\nif (Option.isSome(checkpointOption)) {\n  const checkpoint = checkpointOption.value;\n  if (checkpoint.filterHash !== filterHash \u0026\u0026 !reset) {\n    return yield* CliInputError.make({\n      message: [\n        `Filter changed for derived store \"${target}\".`,\n        ``,\n        `Current: ${checkpoint.filterHash}`,\n        `New:     ${filterHash}`,\n        ``,\n        `Use --reset --yes to rebuild, or omit flag to keep existing filter.`\n      ].join(\"\\n\"),\n      cause: { oldHash: checkpoint.filterHash, newHash: filterHash }\n    });\n  }\n}\n```\n\n### File: src/cli/view.ts (new)\nSimple status command using DerivationValidator:\n```typescript\nconst viewStatus = Command.make(\n  \"status\",\n  { view: Args.text({ name: \"view\" }).pipe(Args.withSchema(StoreName)),\n    source: Args.text({ name: \"source\" }).pipe(Args.withSchema(StoreName)) },\n  ({ view, source }) =\u003e\n    Effect.gen(function* () {\n      const validator = yield* DerivationValidator;\n      const isStale = yield* validator.isStale(view, source);\n      \n      yield* writeJson({\n        view,\n        source,\n        status: isStale ? \"stale\" : \"ready\"\n      });\n    })\n);\n\nexport const viewCommand = Command.make(\"view\").pipe(\n  Command.withSubcommands([viewStatus])\n);\n```\n\n### File: src/cli/app.ts (modify)\nAdd commands to subcommands array.\n\n### File: src/cli/store.ts (modify)\nAdd lineage to show output - see plan lines 496-500.\n\n## Critical Considerations\n- Use CliInputError.make (NOT throw new Error)\n- Validation BEFORE calling DerivationEngine\n- Clear, actionable error messages\n- --reset requires --yes (no interactive prompts)\n- Filter change detection with helpful guidance\n- Use Effect.gen function* pattern\n\n## Acceptance Criteria\n- [ ] derive command compiles\n- [ ] view status command compiles\n- [ ] --mode flag validates choices\n- [ ] --reset requires --yes\n- [ ] EventTime mode rejects effectful filters\n- [ ] Filter changes error with clear message\n- [ ] store show displays lineage when present\n- [ ] Commands added to app.ts\n- [ ] No unsafe Effect patterns\n\n## Verification\n```bash\n# Test help\nskygent derive --help\nskygent view --help\n\n# Test derive\nskygent derive source target --filter-json '{\"_tag\":\"All\"}'\n\n# Test mode validation\nskygent derive source target --filter-json '{\"_tag\":\"Llm\",...}' --mode event-time\n# Should error\n\n# Test reset without yes\nskygent derive source target --filter-json '{\"_tag\":\"Hashtag\",\"tag\":\"#ai\"}' --reset\n# Should error\n\n# Test status\nskygent view status target source\n```\n\n## Related\n- Parent: #1\n- Depends on: skygent-bsky-hm1 (DerivationEngine), skygent-bsky-ijd (validator)\n- Blocks: skygent-bsky layer wiring","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-26T14:21:20.295814-06:00","updated_at":"2026-01-26T15:49:23.831661-06:00","closed_at":"2026-01-26T15:49:23.831661-06:00","close_reason":"Closed","dependencies":[{"issue_id":"skygent-bsky-5h2","depends_on_id":"skygent-bsky-hm1","type":"blocks","created_at":"2026-01-26T14:22:49.542732-06:00","created_by":"daemon"},{"issue_id":"skygent-bsky-5h2","depends_on_id":"skygent-bsky-ijd","type":"blocks","created_at":"2026-01-26T14:22:49.665824-06:00","created_by":"daemon"}]}
{"id":"skygent-bsky-5jc","title":"CR-04: Fix version mismatch between package.json and CLI","description":"","status":"closed","priority":0,"issue_type":"bug","created_at":"2026-01-28T13:10:46.190511-06:00","updated_at":"2026-01-28T14:41:11.698794-06:00","closed_at":"2026-01-28T14:41:11.698794-06:00","close_reason":"Implemented and reviewed in session 2026-01-28"}
{"id":"skygent-bsky-5k0","title":"CR-34: Remove unused vitest devDependencies","description":"","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-28T13:10:48.299874-06:00","updated_at":"2026-01-28T18:16:34.83456-06:00","closed_at":"2026-01-28T18:16:34.83456-06:00","close_reason":"Implemented in cleanup commit"}
{"id":"skygent-bsky-5kq","title":"CR-13: Consolidate duplicated service helpers","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-28T13:10:48.946954-06:00","updated_at":"2026-01-28T15:41:09.022418-06:00","closed_at":"2026-01-28T15:41:09.022418-06:00","close_reason":"Implemented in consolidation commits"}
{"id":"skygent-bsky-601","title":"CR-06: Fix SyncEngine cursor not advancing across pages","description":"","status":"closed","priority":0,"issue_type":"bug","created_at":"2026-01-28T13:10:46.455702-06:00","updated_at":"2026-01-28T14:41:11.699468-06:00","closed_at":"2026-01-28T14:41:11.699468-06:00","close_reason":"Implemented and reviewed in session 2026-01-28"}
{"id":"skygent-bsky-67t","title":"Add real-time Jetstream data source integration","description":"## Background\n\nThe current sync engine relies entirely on polling REST APIs (getTimeline, getFeed, getNotifications) via BskyClient. This approach has inherent limitations:\n\n- **Latency**: Polling introduces delays between actual events and detection (minimum polling interval)\n- **Rate Limits**: REST APIs have strict rate limits that constrain sync frequency\n- **Inefficiency**: Polling repeatedly fetches unchanged data, wasting bandwidth and API quota\n- **Missing Events**: Fast-moving accounts may post and delete content between polls\n\n**Jetstream** provides a real-time WebSocket stream of all Bluesky events, eliminating these limitations. The `effect-jetstream` package (available at `.reference/effect-jetstream/`) is already built and tested, providing an Effect-native integration.\n\n## Bluesky Jetstream Reference\n\n### Endpoints\n- Primary: `wss://jetstream1.us-east.bsky.network/subscribe`\n- Backup: `wss://jetstream2.us-east.bsky.network/subscribe`\n\n### Event Types\n- **CommitCreate**: New record created (post, like, repost, follow)\n- **CommitUpdate**: Existing record modified\n- **CommitDelete**: Record deleted\n- **IdentityEvent**: Handle or DID document changed\n- **AccountEvent**: Account status changed (active, suspended, deleted)\n\n### Filterable Collections\n- `app.bsky.feed.post` - Posts/replies\n- `app.bsky.feed.like` - Likes\n- `app.bsky.feed.repost` - Reposts\n- `app.bsky.graph.follow` - Follows\n- `app.bsky.graph.block` - Blocks\n- `app.bsky.graph.list` - Lists\n- `app.bsky.actor.profile` - Profile updates\n\n### Query Parameters\n- `wantedCollections[]` - Filter to specific collections\n- `wantedDids[]` - Filter to specific DIDs\n- `cursor` - Unix microseconds timestamp for replay\n\n## Implementation Scope\n\n### 1. Domain Model (`src/domain/sync.ts`)\n\nAdd `DataSourceJetstream` to the existing DataSource union:\n\n```typescript\nexport interface DataSourceJetstream {\n  readonly _tag: \"DataSourceJetstream\"\n  readonly endpoint: string  // WebSocket URL\n  readonly collections: ReadonlyArray\u003cstring\u003e  // Filter collections\n  readonly dids: ReadonlyArray\u003cstring\u003e  // Filter DIDs\n  readonly cursor?: number  // Replay from cursor\n  readonly compress?: boolean  // Enable zstd compression\n}\n\nexport const DataSourceJetstream = Data.TaggedClass(\"DataSourceJetstream\")\u003cDataSourceJetstream\u003e()\n\n// Update DataSource union\nexport type DataSource = DataSourceTimeline | DataSourceFeed | DataSourceNotifications | DataSourceJetstream\n```\n\n### 2. JetstreamSyncEngine Service\n\nCreate `src/services/jetstream-sync.ts`:\n\n```typescript\nexport class JetstreamSyncEngine extends Effect.Service\u003cJetstreamSyncEngine\u003e()(\"JetstreamSyncEngine\", {\n  effect: Effect.gen(function* () {\n    const store = yield* StoreWriter\n    const jetstream = yield* JetstreamClient  // from effect-jetstream\n\n    return {\n      // One-shot sync: connect, collect events until caught up, disconnect\n      sync: (config: DataSourceJetstream) =\u003e Effect.gen(function* () {\n        // ...\n      }),\n\n      // Continuous watch: stream events indefinitely\n      watch: (config: DataSourceJetstream) =\u003e Stream.gen(function* () {\n        // ...\n      }),\n    }\n  }),\n}) {}\n```\n\n### 3. Event Adapter\n\nJetstream events have different schema from REST API PostView. Create adapter:\n\n```typescript\n// Jetstream commit event -\u003e domain Post\nconst adaptCommitToPost = (commit: CommitCreate): Option\u003cPost\u003e =\u003e {\n  if (commit.collection !== \"app.bsky.feed.post\") return Option.none()\n  // Transform commit.record to domain Post\n}\n```\n\n### 4. CLI Commands\n\n#### `sync jetstream` - One-shot sync\n```\nskygent sync jetstream [options]\n\nOptions:\n  --endpoint \u003curl\u003e      Jetstream endpoint (default: jetstream1.us-east)\n  --collections \u003clist\u003e  Comma-separated collections to sync\n  --dids \u003clist\u003e         Comma-separated DIDs to filter\n  --cursor \u003ctimestamp\u003e  Replay from cursor (Unix microseconds)\n  --compress            Enable zstd compression\n  --limit \u003cn\u003e           Stop after n events\n```\n\n#### `watch jetstream` - Continuous streaming\n```\nskygent watch jetstream [options]\n\nOptions:\n  --endpoint \u003curl\u003e      Jetstream endpoint\n  --collections \u003clist\u003e  Collections to watch\n  --dids \u003clist\u003e         DIDs to filter\n  --cursor \u003ctimestamp\u003e  Start from cursor\n  --compress            Enable compression\n  --output \u003cformat\u003e     Output format (json, compact, table)\n```\n\n## Technical Considerations\n\n### Authentication\n- Jetstream is **unauthenticated** - no OAuth or session needed\n- Unlike REST APIs, no BskyClient dependency required\n- Can run without any credentials configured\n\n### Reconnection \u0026 Buffering\n- `effect-jetstream` has built-in reconnection with exponential backoff\n- Automatic cursor tracking for seamless reconnection\n- Configurable buffer size for backpressure handling\n\n### Event Schema Differences\n- REST `PostView` includes resolved author, embeds, engagement counts\n- Jetstream `CommitCreate` has raw record + CID, no resolved data\n- May need to hydrate events with REST calls for full PostView equivalent\n\n### Rate Limiting\n- WebSocket connection is NOT rate limited\n- Can receive thousands of events per second\n- Backpressure handled by Effect Stream\n\n### Compression\n- Jetstream supports zstd compression via `compress=true` query param\n- Reduces bandwidth by ~70% for high-volume streams\n- `effect-jetstream` handles decompression transparently\n\n## Acceptance Criteria\n\n- [ ] `DataSourceJetstream` type added to `src/domain/sync.ts` DataSource union\n- [ ] `JetstreamSyncEngine` service implemented in `src/services/jetstream-sync.ts`\n- [ ] Event adapter converts Jetstream commits to domain Post type\n- [ ] `sync jetstream` command performs one-shot sync from cursor\n- [ ] `watch jetstream` command streams events in real-time\n- [ ] Collection filtering (`--collections`) works correctly\n- [ ] DID filtering (`--dids`) works correctly\n- [ ] Cursor replay (`--cursor`) catches up on historical events\n- [ ] Events are persisted via StoreWriter\n- [ ] Existing filters (from filter DSL) apply to Jetstream events\n- [ ] Graceful shutdown on SIGINT/SIGTERM\n\n## Dependencies\n\n- `effect-jetstream` package (already available at `.reference/effect-jetstream/`)\n- Existing `StoreWriter` service\n- Existing filter system\n\n## Related Files\n\n- `src/domain/sync.ts` - DataSource union to extend\n- `src/services/bsky-client.ts` - Reference for REST-based sync\n- `.reference/effect-jetstream/` - Effect-based Jetstream client package\n- `.reference/bsky-docs/` - Bluesky API documentation","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-27T10:38:55.232972-06:00","updated_at":"2026-01-28T16:37:07.908004-06:00","closed_at":"2026-01-28T16:37:07.908004-06:00","close_reason":"Jetstream fully integrated: jetstream-sync.ts + sync/watch jetstream commands"}
{"id":"skygent-bsky-6bx","title":"Add authorDid to @minimal compact output preset","description":"The @minimal field preset (used by default compact output) includes uri, author, text, createdAt but not authorDid. This makes it impossible to generate bsky.app links from compact output since links require the DID:\n\n  https://bsky.app/profile/{authorDid}/post/{rkey}\n\nCompact ndjson piped through jq produces empty DIDs. Workaround is --full but that's heavy. authorDid should be added to the @minimal preset.\n\nDiscovered during testing: tried to generate clickable links from compact query output of arsenal-spurs-lol view.","status":"open","priority":2,"issue_type":"bug","created_at":"2026-01-31T23:15:39.066458-06:00","updated_at":"2026-01-31T23:15:39.066458-06:00"}
{"id":"skygent-bsky-6eo","title":"Add search posts command for full-text post discovery","description":"## Background\n\nCurrently the BskyClient has methods for fetching timeline, feeds, notifications, and individual posts, but there is no search capability. This means users cannot discover posts by keyword, hashtag, or content beyond what appears in their configured feeds.\n\n**Use cases for search:**\n- Research: Find historical discussions on specific topics\n- Trend analysis: Track emerging hashtags and conversations\n- Content discovery: Find posts about niche interests\n- Monitoring: Watch for mentions of brands, projects, or topics\n\n## Bluesky API Reference\n\n**Endpoint:** \\`app.bsky.feed.searchPosts\\`\n\n**Parameters:**\n| Parameter | Type | Required | Description |\n|-----------|------|----------|-------------|\n| \\`q\\` | string | Yes | Search query string |\n| \\`sort\\` | 'top' \\| 'latest' | No | Sort order (default: latest) |\n| \\`since\\` | string | No | ISO datetime - filter posts after this time |\n| \\`until\\` | string | No | ISO datetime - filter posts before this time |\n| \\`mentions\\` | string | No | Filter to posts mentioning this handle |\n| \\`author\\` | string | No | Filter to posts by specific author |\n| \\`lang\\` | string | No | Language filter (ISO 639-1 code) |\n| \\`domain\\` | string | No | Filter to posts containing links to this domain |\n| \\`url\\` | string | No | Filter to posts containing this specific URL |\n| \\`tag\\` | string | No | Filter by hashtag (without the # symbol) |\n| \\`limit\\` | number | No | Results per page, 1-100 (default: 25) |\n| \\`cursor\\` | string | No | Pagination cursor |\n\n**Response:** \\`{ posts: PostView[], cursor?: string }\\`\n\n## Implementation Scope\n\n### BskyClient Changes\nAdd \\`searchPosts(query, options?)\\` method to BskyClient:\n\\`\\`\\`typescript\ninterface SearchPostsOptions {\n  sort?: 'top' | 'latest'\n  since?: string\n  until?: string\n  mentions?: string\n  author?: string\n  lang?: string\n  domain?: string\n  url?: string\n  tag?: string\n  limit?: number\n  cursor?: string\n}\n\nsearchPosts(query: string, options?: SearchPostsOptions): Effect\u003cSearchPostsResult, BskyError\u003e\n\\`\\`\\`\n\n### DataSource Extension\nAdd \\`DataSourceSearch\\` to the DataSource union type in sync.ts:\n\\`\\`\\`typescript\ninterface DataSourceSearch {\n  readonly _tag: \"Search\"\n  readonly query: string\n  readonly options?: SearchPostsOptions\n}\n\\`\\`\\`\n\n### Parser Integration\nReuse existing \\`toRawPost()\\` function for parsing PostView responses into RawPost format.\n\n## CLI Integration\n\n### Sync Commands\n\\`\\`\\`bash\n# Basic search - search and store results\nsync search \"query\"\n\n# Sorted search with limit\nsync search \"AI\" --sort top --limit 100\n\n# Author filter\nsync search \"bluesky\" --author user.bsky.social\n\n# Hashtag with date filter\nsync search --tag javascript --since 2024-01-01\n\n# Combine multiple filters\nsync search \"effect-ts\" --tag typescript --sort top --since 2024-06-01\n\\`\\`\\`\n\n### Watch Mode\n\\`\\`\\`bash\n# Monitor search results continuously\nwatch search \"breaking news\" --interval 5m\n\n# Watch for new posts with hashtag\nwatch search --tag bluesky --interval 10m\n\\`\\`\\`\n\n## Technical Considerations\n\n1. **Result Stability:** Search results change over time as posts are created, deleted, or their engagement metrics change. Unlike timeline/feed syncing, the same query may return different results minutes apart.\n\n2. **Rate Limiting:** The search API is subject to rate limits. Implementation should:\n   - Respect rate limit headers\n   - Implement backoff when limits are hit\n   - Consider caching recent queries\n\n3. **Pagination:** Large result sets require pagination handling:\n   - Support fetching all results via cursor iteration\n   - Consider maximum total results limit to prevent runaway queries\n\n4. **Deduplication:** Search results may overlap with posts already in the store from timeline/feed syncs:\n   - Check for existing posts before insert\n   - Update engagement metrics if post exists\n   - Track source of each post (search vs feed vs timeline)\n\n5. **Index Optimization:** Consider adding indexes for efficient search result queries:\n   - Index on post text for local re-filtering\n   - Index on creation date for time-range queries\n\n## Acceptance Criteria\n\n- [ ] \\`searchPosts(query, options?)\\` method added to BskyClient\n- [ ] \\`DataSourceSearch\\` type added to DataSource union\n- [ ] \\`sync search \"query\"\\` command works for basic searches\n- [ ] All filter options work correctly:\n  - [ ] \\`--sort\\` (top/latest)\n  - [ ] \\`--since\\` / \\`--until\\` date filters\n  - [ ] \\`--author\\` handle filter\n  - [ ] \\`--tag\\` hashtag filter\n  - [ ] \\`--mentions\\` filter\n  - [ ] \\`--lang\\` language filter\n  - [ ] \\`--domain\\` / \\`--url\\` link filters\n  - [ ] \\`--limit\\` pagination\n- [ ] \\`watch search\\` polling mode works with configurable interval\n- [ ] Search results are stored and indexed correctly in the store\n- [ ] Duplicate posts are handled gracefully (update if exists)\n- [ ] Rate limiting is handled appropriately\n- [ ] Help text and documentation updated\n\n## Related\n\n- BskyClient implementation\n- Sync command infrastructure\n- Watch mode implementation\n- Store post deduplication logic","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-27T10:42:07.326149-06:00","updated_at":"2026-01-27T10:42:29.644845-06:00"}
{"id":"skygent-bsky-6l1","title":"CR-01: Replace Date.now() with Effect Clock across services","description":"","status":"closed","priority":0,"issue_type":"bug","created_at":"2026-01-28T13:10:45.763029-06:00","updated_at":"2026-01-28T14:41:11.692367-06:00","closed_at":"2026-01-28T14:41:11.692367-06:00","close_reason":"Implemented and reviewed in session 2026-01-28"}
{"id":"skygent-bsky-6wv","title":"CR-38: Add description to configCheckCommand","description":"","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-28T13:10:48.946537-06:00","updated_at":"2026-01-28T18:16:34.835322-06:00","closed_at":"2026-01-28T18:16:34.835322-06:00","close_reason":"Implemented in cleanup commit"}
{"id":"skygent-bsky-70i","title":"Bulk multi-source sync command with serialized writes","description":"sync multi command that fetches from multiple sources concurrently but serializes SQLite writes through a single connection to avoid SQLITE_BUSY lock contention. See GitHub #140 for full details including architecture diagram and real-world failure case.","status":"open","priority":2,"issue_type":"feature","created_at":"2026-02-01T11:58:32.735291-06:00","updated_at":"2026-02-01T11:58:32.735291-06:00"}
{"id":"skygent-bsky-70o","title":"Store lock not cleared on interrupted/cancelled sync","description":"","status":"open","priority":2,"issue_type":"bug","created_at":"2026-01-29T17:53:39.610771-06:00","updated_at":"2026-01-29T17:53:39.610771-06:00"}
{"id":"skygent-bsky-7c5","title":"Feed sync dies on single parse error instead of skipping","description":"","status":"open","priority":1,"issue_type":"bug","created_at":"2026-01-29T17:53:39.747074-06:00","updated_at":"2026-01-29T17:53:39.747074-06:00"}
{"id":"skygent-bsky-7n4","title":"CR-35: Remove changeset tooling from private package","description":"","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-28T13:10:48.486252-06:00","updated_at":"2026-01-28T13:10:48.486252-06:00"}
{"id":"skygent-bsky-7x4","title":"Embed full author profile metadata in Post model","description":"## Background\n\nThe current Post model only stores minimal author information (handle and DID), discarding valuable profile metadata that's already present in Bluesky API responses. This limits our ability to perform author analytics, influence tracking, and profile-based search without additional API calls.\n\n### Current Limitation\n- Post only stores `author: Handle` and `authorDid: Did`\n- API responses include the full ProfileViewBasic with display names, avatars, follower counts, and more\n- Reconstructing author context requires additional API calls per post\n\n### Use Cases Enabled by This Change\n- **Author Analytics**: Analyze posting patterns alongside follower growth\n- **Influence Tracking**: Correlate engagement with author reach metrics\n- **Profile Search**: Filter posts by author attributes (verified, follower count thresholds)\n- **Rich Display**: Show author avatars, display names, and badges without extra fetches\n\n## Current State\n\n### Post Model (`src/domain/post.ts`)\n```typescript\n// Currently stores only:\nauthor: Handle,      // e.g., \"@alice.bsky.social\"\nauthorDid: Did,      // e.g., \"did:plc:...\"\n```\n\n### ProfileBasic (`src/domain/bsky.ts`)\nThe `decodeProfileBasic()` function already parses the full profile:\n```typescript\nProfileBasic {\n  did: Did\n  handle: Handle\n  displayName: Option\u003cDisplayName\u003e\n  pronouns: Option\u003cstring\u003e\n  avatar: Option\u003cstring\u003e\n  associated: Option\u003cProfileAssociated\u003e\n  viewer: Option\u003cViewerState\u003e\n  labels: Array\u003cLabel\u003e\n  createdAt: Option\u003cDateTime.Utc\u003e\n  verification: Option\u003cVerificationStatus\u003e\n  status: Option\u003cActiveStatus\u003e\n}\n```\n\n### BskyClient Behavior\n- `BskyClient.getPosts()` and `BskyClient.getAuthorFeed()` receive full `ProfileViewBasic` on every post\n- The profile is currently parsed but only handle/did are extracted for the Post model\n- All additional metadata is discarded\n\n## Bluesky API Reference\n\n### ProfileViewBasic (returned on every PostView.author)\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `did` | string | ✓ Already stored |\n| `handle` | string | ✓ Already stored |\n| `displayName` | string? | User's chosen display name |\n| `description` | string? | Bio/profile description |\n| `avatar` | string? | Avatar image URL |\n| `banner` | string? | Banner image URL |\n| `followersCount` | number? | Number of followers |\n| `followsCount` | number? | Number of accounts followed |\n| `postsCount` | number? | Total posts by author |\n| `associated` | object? | Lists, feeds, labeler, chat settings |\n| `viewer` | object? | Relationship: muted, blockedBy, following, followedBy |\n| `labels` | array | Content labels applied to account |\n| `verification` | object? | Verification status |\n| `status` | object? | Active/deactivated status |\n\nReference: `app.bsky.actor.defs#profileViewBasic`\n\n## Implementation Scope\n\n### 1. Update Post Model\n```typescript\n// Before:\nauthor: Handle,\nauthorDid: Did,\n\n// After:\nauthor: ProfileBasic,\n```\n\n### 2. Update PostParser\n- Modify `decodePost()` to preserve the full `ProfileBasic` instead of extracting only handle/did\n- Ensure the full profile object is passed through the parsing pipeline\n\n### 3. Update RawPost Schema\n- The stored JSON schema needs to include the full author profile\n- Update schema validation if present\n\n### 4. Update Dependent Code\n- Any code accessing `post.author` (currently Handle) needs migration to `post.author.handle`\n- Any code accessing `post.authorDid` needs migration to `post.author.did`\n- Update query field paths if needed\n\n## Migration Considerations\n\n### Backward Compatibility\n- **Existing posts**: Have only handle/did stored\n- **New posts**: Will have full ProfileBasic\n\n### Strategies\n1. **Graceful Degradation**: Query/filter code handles both formats\n   - Check for `author.handle` first, fall back to `author` if string\n2. **Lazy Enrichment**: Optionally enrich old posts on read\n   - Cache profile lookups to avoid repeated API calls\n3. **Migration Helper**: Batch update script for existing stores\n   - Iterate stored posts, fetch profiles, update in place\n\n### Store Format\nConsider how ProfileBasic serializes:\n```json\n{\n  \"author\": {\n    \"did\": \"did:plc:...\",\n    \"handle\": \"alice.bsky.social\",\n    \"displayName\": \"Alice\",\n    \"avatar\": \"https://...\",\n    \"followersCount\": 1234,\n    ...\n  }\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Post model updated to use `author: ProfileBasic` instead of separate handle/did fields\n- [ ] PostParser preserves full author profile from API responses\n- [ ] RawPost schema updated to include full author object\n- [ ] New synced posts include complete author profile metadata\n- [ ] Existing posts without full profile still load and function correctly\n- [ ] `query --fields author.displayName,author.followersCount` returns author metadata\n- [ ] All existing tests pass (with necessary updates)\n- [ ] Backward compatibility documented\n\n## Future Enhancements (Out of Scope)\n- Filter posts by author metrics: `--filter \"author.followersCount \u003e 1000\"`\n- Author deduplication/normalization across posts\n- Profile change tracking over time","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-27T10:38:55.685711-06:00","updated_at":"2026-01-28T16:37:07.773076-06:00","closed_at":"2026-01-28T16:37:07.773076-06:00","close_reason":"Post.authorProfile already exists (commit 98f6871)"}
{"id":"skygent-bsky-8ew","title":"CR-17: Document config check command in CLI docs","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-28T13:10:49.490074-06:00","updated_at":"2026-01-28T15:49:22.491014-06:00","closed_at":"2026-01-28T15:49:22.491014-06:00","close_reason":"Implemented: docs for config check, sync env vars, and TrendingTopics BskyClient refactor"}
{"id":"skygent-bsky-9ed","title":"Add derivation domain types and EventMeta provenance","description":"**Plan Reference**: /Users/pooks/.claude/plans/cosmic-popping-cake.md - Phase 1, sections 1.1, 1.2, 1.3\n\n## Goal\nCreate domain types for store derivation with proper Effect Schema patterns. Add event provenance tracking to EventMeta.\n\n## Pre-Implementation Research\n\n### 1. Review Existing Code\n- Read src/domain/events.ts - understand EventMeta pattern\n- Read src/domain/store.ts - understand Schema.Class usage\n- Read src/domain/primitives.ts - understand branded types\n- Read src/domain/filter.ts - understand FilterExpr ADT structure\n\n### 2. Effect Documentation Research\nUse effect-docs MCP to research:\n```\neffect-docs search \"Schema.Class\"\neffect-docs search \"Schema.TaggedError\"\neffect-docs search \"Schema.Literal\"\neffect-docs search \"branded types\"\n```\n\nStudy:\n- Schema.Class vs Schema.Struct (when to use each)\n- .make() constructor pattern (NEVER use 'new')\n- Schema.TaggedError for domain errors\n- Schema.Literal for union types\n- Schema.optional() for optional fields\n\n### 3. Review Effect Source\nCheck @effect/schema source for:\n- TaggedError implementation patterns\n- Class constructor best practices\n- Avoid unsafe patterns (Schema.to, Schema.from without validation)\n\n## Implementation - See Plan for Full Code\n\nAcceptance Criteria in plan sections 1.1, 1.2, 1.3\n\n## Related\n- Parent: #1\n- Blocks: All other derivation work","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-26T14:14:41.526843-06:00","updated_at":"2026-01-26T14:28:25.912755-06:00","closed_at":"2026-01-26T14:28:25.912758-06:00"}
{"id":"skygent-bsky-9rs","title":"CR-26: Extract shared test infrastructure","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-28T13:10:48.301769-06:00","updated_at":"2026-01-28T13:10:48.301769-06:00"}
{"id":"skygent-bsky-ag4","title":"CR-22: Add false-path tests for filter runtime","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-28T13:10:47.654299-06:00","updated_at":"2026-01-28T13:10:47.654299-06:00"}
{"id":"skygent-bsky-b3q","title":"CR-16: Add --limit validation to query command","description":"","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-28T13:10:49.355553-06:00","updated_at":"2026-01-28T15:44:28.795466-06:00","closed_at":"2026-01-28T15:44:28.795466-06:00","close_reason":"Implemented: Handle regex i-flag, NonNegativeInt limit, CLI limit validation"}
{"id":"skygent-bsky-bi2","title":"CR-32: Add JSDoc to exported domain types","description":"","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-28T13:10:47.969881-06:00","updated_at":"2026-01-28T13:10:47.969881-06:00"}
{"id":"skygent-bsky-cdy","title":"CR-27: Move misplaced test files to tests/services/","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-28T13:10:48.48668-06:00","updated_at":"2026-01-28T13:10:48.48668-06:00"}
{"id":"skygent-bsky-d7f","title":"CR-07: Type-safe extractFromFacets with RichTextFacet","description":"","status":"closed","priority":0,"issue_type":"bug","created_at":"2026-01-28T13:10:46.58677-06:00","updated_at":"2026-01-28T14:41:11.699909-06:00","closed_at":"2026-01-28T14:41:11.699909-06:00","close_reason":"Implemented and reviewed in session 2026-01-28"}
{"id":"skygent-bsky-dhb","title":"CR-25: Add tests for settings validation","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-28T13:10:48.134332-06:00","updated_at":"2026-01-28T13:10:48.134332-06:00"}
{"id":"skygent-bsky-dw6","title":"CR-33: Fix extractLinks URL regex trailing punctuation","description":"","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-28T13:10:48.133907-06:00","updated_at":"2026-01-28T18:16:34.83399-06:00","closed_at":"2026-01-28T18:16:34.83399-06:00","close_reason":"Implemented in cleanup commit"}
{"id":"skygent-bsky-e60","title":"Community detection from store interaction data","description":"Connected components, SCC, and Louvain community detection on store interaction graphs. Effect Graph.connectedComponents/stronglyConnectedComponents + custom Louvain. See GitHub issue.","status":"open","priority":2,"issue_type":"feature","created_at":"2026-02-01T12:35:32.694586-06:00","updated_at":"2026-02-01T12:35:32.694586-06:00"}
{"id":"skygent-bsky-ebn","title":"CR-37: Remove trivial cli/format.ts re-export","description":"","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-28T13:10:48.793791-06:00","updated_at":"2026-01-28T18:16:34.834965-06:00","closed_at":"2026-01-28T18:16:34.834965-06:00","close_reason":"Implemented in cleanup commit"}
{"id":"skygent-bsky-em2","title":"CR-29: Fix PostFromRaw encode path for mentionDids round-trip","description":"","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-28T13:10:47.506452-06:00","updated_at":"2026-01-28T13:10:47.506452-06:00"}
{"id":"skygent-bsky-ep5","title":"CR-05: Fix StoreDb SQLite client leak on store deletion","description":"","status":"closed","priority":0,"issue_type":"bug","created_at":"2026-01-28T13:10:46.321742-06:00","updated_at":"2026-01-28T14:41:11.699107-06:00","closed_at":"2026-01-28T14:41:11.699107-06:00","close_reason":"Implemented and reviewed in session 2026-01-28"}
{"id":"skygent-bsky-g0p","title":"CR-15: Extract sync/watch command factory","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-28T13:10:49.219955-06:00","updated_at":"2026-01-28T15:41:09.026268-06:00","closed_at":"2026-01-28T15:41:09.026268-06:00","close_reason":"Implemented in consolidation commits"}
{"id":"skygent-bsky-g4d","title":"CR-14: Consolidate duplicated CLI option definitions","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-28T13:10:49.085578-06:00","updated_at":"2026-01-28T15:41:09.025708-06:00","closed_at":"2026-01-28T15:41:09.025708-06:00","close_reason":"Implemented in consolidation commits"}
{"id":"skygent-bsky-h29","title":"CR-31: Deduplicate store tree rendering logic","description":"","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-28T13:10:47.816272-06:00","updated_at":"2026-01-28T13:10:47.816272-06:00"}
{"id":"skygent-bsky-hek","title":"Add image/embed extraction to query output","description":"## Problem\nCompact output drops embeds entirely — agents consuming skygent output get zero image context. There's no way to extract image URLs, thumbnails, or alt text from stored posts without parsing raw JSON.\n\n## Current State\n- Compact output: uri, author, text, createdAt only — no embed info\n- Full output includes entire Post object (verbose, hard to parse)\n- No field presets that include image-specific data\n- query --fields can select embed but returns nested structure\n\n## Proposed Changes\n\n### Compact Output Enhancement\n- Add embed_summary field to compact output: { type, image_count, has_alt_text, thumbnail_url }\n- Lightweight enough for agent consumption, informative enough to decide whether to fetch full post\n\n### Field Presets\n- @images preset: uri, author, text, createdAt, images[].{fullsize, thumb, alt, aspectRatio}\n- @embeds preset: uri, author, text, createdAt, embed (flattened)\n- @media preset: combines @images + video + external link data\n\n### Extract Mode\n- query --extract-images: emit one line per image (not per post) — { postUri, author, imageUrl, thumbUrl, alt, aspectRatio }\n- Useful for bulk image URL collection, broken link detection, CDN analysis\n\n## Use Cases\n- Agent pipelines: get image URLs without parsing full JSON\n- Content moderation: bulk extract images for review\n- Accessibility reports: extract alt text coverage stats\n- Media archival: collect all image URLs for download","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-31T23:44:36.8958-06:00","updated_at":"2026-01-31T23:44:36.8958-06:00"}
{"id":"skygent-bsky-hhr","title":"Local image caching and archival","description":"## Problem\nImage URLs in posts are CDN references that can expire or become unavailable. For an agent-first service, relying on external URLs means data loss risk and network dependency for image access.\n\n## Current State\n- Image URLs (fullsize, thumb) stored as strings in post_json\n- No local copies of image data\n- No URL validation or availability checking\n- Bluesky CDN URLs can change or expire over time\n- Video playlist URLs similarly ephemeral\n\n## Proposed Changes\n\n### Image Cache Store\n- New cache directory under store root: {store-root}/.image-cache/\n- Content-addressed storage: hash of image CID or URL → local file\n- Metadata sidecar: original URL, download timestamp, content type, size, dimensions\n\n### Cache Commands\n- store cache \u003cname\u003e [--images] [--thumbnails] [--limit N]: download and cache images from a store\n- store cache-status \u003cname\u003e: report cache coverage (cached/total images, total size)\n- store cache-clean \u003cname\u003e [--older-than \u003cduration\u003e]: evict old cached images\n\n### Integration\n- query --resolve-images: rewrite image URLs to local file paths when cached\n- Lazy caching option: cache on first access during query\n- Background caching during sync/watch (opt-in)\n\n### Scope Considerations\n- Start with thumbnails only (much smaller, sufficient for previews)\n- Full-size download as opt-in\n- Video caching out of scope initially (large files, playlist complexity)\n- Respect rate limits on Bluesky CDN\n\n## Use Cases\n- Offline analysis: work with cached posts including images\n- Archival: preserve image data against CDN expiry\n- Agent workflows: local image processing without network calls\n- Content analysis: feed cached images to vision models","status":"open","priority":3,"issue_type":"feature","created_at":"2026-01-31T23:44:40.531819-06:00","updated_at":"2026-01-31T23:44:40.531819-06:00"}
{"id":"skygent-bsky-hm1","title":"Implement DerivationEngine service with delete propagation and checkpointing","description":"**Plan Reference**: /Users/pooks/.claude/plans/cosmic-popping-cake.md - Phase 1, DerivationEngine section (lines 208-435)\n\n## Goal\nImplement core derivation logic: event replay, filter evaluation, PostDelete propagation, URI deduplication, checkpointing, and lineage tracking.\n\n## Pre-Implementation Research\n\n### 1. Review Existing Code (CRITICAL)\n- Read src/services/sync-engine.ts - understand event processing patterns\n- Read src/services/filter-runtime.ts - understand filter evaluation\n- Read src/services/filter-compiler.ts - understand FilterSpec compilation\n- Read src/services/store-writer.ts - understand event appending\n- Read src/services/store-index.ts - understand hasUri() and apply()\n- Study Stream.runFoldEffect pattern for stateful streaming\n\n### 2. Effect Documentation Research\nUse effect-docs MCP extensively:\n```\neffect-docs search \"Stream.runFoldEffect\"\neffect-docs search \"Stream.filter\"\neffect-docs search \"Clock.currentTimeMillis\"\neffect-docs search \"Schema.decodeUnknown\"\neffect-docs search \"Option.match\"\neffect-docs search \"Effect.gen function*\"\n```\n\nStudy deeply:\n- Stream processing with effects\n- runFoldEffect for accumulating state\n- Clock service for timestamps (NEVER Date.now())\n- Schema.decodeUnknown for safe timestamp creation\n- Option handling (match, flatMap, isSome, isNone)\n- Effect error propagation\n\n### 3. Review Effect Source (CRITICAL)\nStudy Stream implementation:\n- How runFoldEffect handles errors\n- State accumulation patterns\n- Filter composition\n- Early termination\n\nStudy Effect.gen:\n- yield* semantics\n- Error short-circuiting\n- Effect composition\n\n## Implementation\n\nSee plan lines 218-435 for complete code. Key sections:\n\n### EventTime Mode Guard\n```typescript\nif (options.mode === \"EventTime\" \u0026\u0026 isEffectfulFilter(filterExpr)) {\n  return yield* DerivationError.make({\n    reason: \"EventTime mode only supports pure filters. Use --mode derive-time.\",\n    sourceStore: sourceRef.name,\n    targetStore: targetRef.name\n  });\n}\n```\n\n### FilterSpec Compilation\n```typescript\nconst filterSpec = FilterSpec.make({\n  name: \"derive\",\n  expr: filterExpr,\n  output: FilterOutput.make({ path: \"derive\", json: false, markdown: false })\n});\nyield* compiler.compile(filterSpec);\nconst predicate = yield* runtime.evaluate(filterExpr);\n```\n\n### Checkpoint-Based Incremental Derivation\n```typescript\nconst startAfter = Option.flatMap(checkpointOption, (cp) =\u003e\n  cp.filterHash === filterHash \u0026\u0026 cp.evaluationMode === options.mode\n    ? cp.lastSourceEventId\n    : Option.none()\n);\n\nyield* eventLog.stream(sourceRef).pipe(\n  Stream.filter((record) =\u003e\n    Option.match(startAfter, {\n      onNone: () =\u003e true,\n      onSome: (id) =\u003e record.id.localeCompare(id) \u003e 0  // CRITICAL: localeCompare for ULID\n    })\n  ),\n  // ...\n)\n```\n\n### PostDelete Propagation (UNFILTERED)\n```typescript\nif (event._tag === \"PostDelete\") {\n  const derivedMeta = EventMeta.make({\n    ...event.meta,\n    sourceStore: sourceRef.name\n  });\n  const derivedEvent = PostDelete.make({ ...event, meta: derivedMeta });\n  const targetRecord = yield* writer.append(targetRef, derivedEvent);\n  yield* index.apply(targetRef, targetRecord);\n  return { processed: state.processed + 1, ..., deletes: state.deletes + 1, lastSourceId: nextLast };\n}\n```\n\n### URI Deduplication\n```typescript\nconst exists = yield* index.hasUri(targetRef, event.post.uri);\nif (exists) {\n  return { processed: state.processed + 1, ..., skipped: state.skipped + 1, ... };\n}\n```\n\n### Timestamp Creation (SAFE)\n```typescript\nconst endTimeMillis = yield* Clock.currentTimeMillis;\nconst timestamp = yield* Schema.decodeUnknown(Timestamp)(\n  new Date(endTimeMillis).toISOString()\n);\n```\n\n## Critical Considerations\n- NEVER use Date.now() - use Clock.currentTimeMillis\n- NEVER use 'new' for Schema.Class - use .make()\n- Use localeCompare() for ULID EventId comparison\n- ALL PostDelete events propagate (unfiltered)\n- Check hasUri() before filter evaluation (optimization)\n- Use Effect.fn() for derive method\n- Proper error mapping (DerivationError, StoreIoError, FilterError)\n\n## Acceptance Criteria\n- [ ] DerivationEngine compiles without errors\n- [ ] EventTime mode rejects effectful filters\n- [ ] DeriveTime mode accepts all filters\n- [ ] PostDelete propagates unfiltered\n- [ ] hasUri() prevents duplicates\n- [ ] Checkpointing works incrementally\n- [ ] localeCompare used for EventId comparison\n- [ ] Clock service used for timestamps\n- [ ] Lineage saved after successful derivation\n- [ ] No unsafe Effect patterns\n\n## Verification\n```bash\n# Unit tests\nbun test tests/services/derivation-engine.test.ts\n\n# Manual test\nskygent derive test-source test-target --filter-json '{\"_tag\":\"All\"}'\n```\n\n## Related\n- Parent: #1\n- Depends on: skygent-bsky-9ed, skygent-bsky-uej, skygent-bsky-293\n- Blocks: skygent-bsky CLI integration","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-26T14:18:58.68142-06:00","updated_at":"2026-01-26T15:30:10.700536-06:00","closed_at":"2026-01-26T15:30:10.700536-06:00","close_reason":"Closed","dependencies":[{"issue_id":"skygent-bsky-hm1","depends_on_id":"skygent-bsky-293","type":"blocks","created_at":"2026-01-26T14:22:49.277676-06:00","created_by":"daemon"},{"issue_id":"skygent-bsky-hm1","depends_on_id":"skygent-bsky-uej","type":"blocks","created_at":"2026-01-26T14:22:49.41326-06:00","created_by":"daemon"}]}
{"id":"skygent-bsky-i05","title":"CR-23: Add tests for store-commit deduplication","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-28T13:10:47.816272-06:00","updated_at":"2026-01-28T13:10:47.816272-06:00"}
{"id":"skygent-bsky-i0i","title":"CR-02: Add DateRange start \u003c end validation","description":"","status":"closed","priority":0,"issue_type":"bug","created_at":"2026-01-28T13:10:45.916349-06:00","updated_at":"2026-01-28T14:41:11.697591-06:00","closed_at":"2026-01-28T14:41:11.697591-06:00","close_reason":"Implemented and reviewed in session 2026-01-28"}
{"id":"skygent-bsky-ijd","title":"Implement DerivationValidator for O(1) staleness detection","description":"**Plan Reference**: /Users/pooks/.claude/plans/cosmic-popping-cake.md - Phase 2, section 3.2 (lines 549-561)\n\n## Goal\nCreate efficient staleness detection using getLastEventId() instead of O(n) stream scanning.\n\n## Pre-Implementation Research\n\n### 1. Review Existing Code\n- Read src/services/store-event-log.ts - understand getLastEventId() API\n- Read src/services/view-checkpoint-store.ts - understand checkpoint structure\n- Read src/services/store-manager.ts - understand getStore() pattern\n- Study Option handling patterns in existing services\n\n### 2. Effect Documentation Research\nUse effect-docs MCP:\n```\neffect-docs search \"Option.match\"\neffect-docs search \"Option.isNone\"\neffect-docs search \"Option.flatMap\"\neffect-docs search \"Context.Tag service\"\n```\n\nStudy:\n- Option combinators (match, flatMap, map)\n- Service composition patterns\n- Effect.fn() for tracing\n- Layer dependency injection\n\n### 3. Review Effect Source\nCheck Option implementation:\n- match vs if/else patterns\n- flatMap for chaining\n- Type-safe none handling\n\n## Implementation\n\n### File: src/services/derivation-validator.ts (new)\n```typescript\nimport { Context, Effect, Layer, Option } from \"effect\";\nimport { ViewCheckpointStore } from \"./view-checkpoint-store.js\";\nimport { StoreEventLog } from \"./store-event-log.js\";\nimport { StoreManager } from \"./store-manager.js\";\nimport { StoreName } from \"../domain/primitives.js\";\nimport { StoreIoError } from \"../domain/errors.js\";\n\nexport class DerivationValidator extends Context.Tag(\n  \"@skygent/DerivationValidator\"\n)\u003c\n  DerivationValidator,\n  {\n    readonly isStale: (\n      viewName: StoreName,\n      sourceName: StoreName\n    ) =\u003e Effect.Effect\u003cboolean, StoreIoError\u003e;\n  }\n\u003e() {\n  static readonly layer = Layer.effect(\n    DerivationValidator,\n    Effect.gen(function* () {\n      const checkpoints = yield* ViewCheckpointStore;\n      const eventLog = yield* StoreEventLog;\n      const storeManager = yield* StoreManager;\n\n      const isStale = Effect.fn(\"DerivationValidator.isStale\")(\n        (viewName: StoreName, sourceName: StoreName) =\u003e\n          Effect.gen(function* () {\n            const checkpointOption = yield* checkpoints.load(viewName, sourceName);\n\n            if (Option.isNone(checkpointOption)) {\n              return true; // Never materialized\n            }\n\n            const checkpoint = checkpointOption.value;\n\n            // O(1) optimization: use getLastEventId instead of streaming\n            const sourceRefOption = yield* storeManager.getStore(sourceName);\n            if (Option.isNone(sourceRefOption)) {\n              return false; // Source store deleted\n            }\n\n            const sourceRef = sourceRefOption.value;\n            const lastSourceIdOption = yield* eventLog.getLastEventId(sourceRef);\n\n            if (Option.isNone(lastSourceIdOption)) {\n              return false; // Source has no events\n            }\n\n            const lastSourceId = lastSourceIdOption.value;\n\n            if (Option.isNone(checkpoint.lastSourceEventId)) {\n              return true; // Checkpoint never recorded a last event\n            }\n\n            // CRITICAL: use localeCompare for ULID EventId strings\n            return lastSourceId.localeCompare(checkpoint.lastSourceEventId.value) \u003e 0;\n          })\n      );\n\n      return DerivationValidator.of({ isStale });\n    })\n  );\n}\n```\n\n## Critical Considerations\n- Use getLastEventId() NOT Stream.runLast (O(1) vs O(n))\n- Use localeCompare() for ULID string comparison\n- Handle all Option cases (none checkpoint, none source, none events)\n- Use Effect.fn() for tracing\n- Map errors to StoreIoError\n\n## Acceptance Criteria\n- [ ] DerivationValidator compiles\n- [ ] isStale() returns true when source has new events\n- [ ] isStale() returns false when up-to-date\n- [ ] isStale() returns true when never materialized\n- [ ] isStale() returns false when source deleted/empty\n- [ ] Uses getLastEventId (O(1) optimization)\n- [ ] localeCompare used for EventId comparison\n- [ ] Effect.fn() used\n- [ ] No unsafe patterns\n\n## Verification\n```bash\n# Unit test\nbun test tests/services/derivation-validator.test.ts\n\n# Manual test\nskygent derive source target --filter-json '{\"_tag\":\"All\"}'\nskygent view status target source  # Should show \"ready\"\nskygent sync timeline --store source --limit 10\nskygent view status target source  # Should show \"stale\"\n```\n\n## Related\n- Parent: #1\n- Depends on: skygent-bsky-uej (getLastEventId), skygent-bsky-293 (checkpoint store)\n- Blocks: skygent-bsky CLI view command","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-26T14:19:46.385986-06:00","updated_at":"2026-01-26T15:38:42.51994-06:00","closed_at":"2026-01-26T15:38:42.51994-06:00","close_reason":"Closed","dependencies":[{"issue_id":"skygent-bsky-ijd","depends_on_id":"skygent-bsky-uej","type":"blocks","created_at":"2026-01-26T14:22:49.026343-06:00","created_by":"daemon"}]}
{"id":"skygent-bsky-jmj","title":"CR-28: Use canonical serialization for filterExprSignature","description":"","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-28T13:10:47.356328-06:00","updated_at":"2026-01-28T18:16:34.832661-06:00","closed_at":"2026-01-28T18:16:34.832661-06:00","close_reason":"Implemented in cleanup commit"}
{"id":"skygent-bsky-kcd","title":"First-class feed and author source management for stores","description":"Stores should explicitly model their relationship to Bluesky sources (authors, feeds, lists). Persistent source config, simplified sync, author-level operations, source-aware derivation. See GitHub issue for full breakdown into 6 phases.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-01T12:46:09.826655-06:00","updated_at":"2026-02-01T12:46:09.826655-06:00"}
{"id":"skygent-bsky-ks4","title":"CR-21: Add tests for store-lock concurrent access","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-28T13:10:47.50645-06:00","updated_at":"2026-01-28T13:10:47.50645-06:00"}
{"id":"skygent-bsky-lyc","title":"Add Follow graph store for relationship tracking","description":"## Background\n\nCurrently, the system has no social graph storage capability. This means we cannot:\n- Track who follows whom\n- Answer questions like \"Who does X follow?\" or \"Who follows X?\"\n- Analyze follower relationships or detect changes over time\n\n### Use Cases\n- **Audience analysis**: Understand the composition of an account's followers\n- **Follow/unfollow tracking**: Detect when relationships change\n- **Network visualization**: Map connections between accounts\n- **Mutual follow detection**: Find common connections\n\n## Bluesky API Reference\n\n### `app.bsky.graph.getFollows` - Who an actor follows\n- **Parameters**: `actor` (required), `limit` (max 100), `cursor`\n- **Returns**: `follows[]` containing `ProfileView` objects\n- **Use**: Fetch the outgoing follow edges for an account\n\n### `app.bsky.graph.getFollowers` - Who follows an actor\n- **Parameters**: `actor` (required), `limit` (max 100), `cursor`\n- **Returns**: `followers[]` containing `ProfileView` objects\n- **Use**: Fetch the incoming follow edges for an account\n\n### `app.bsky.graph.getKnownFollowers` - Mutual follows\n- **Parameters**: `actor` (required)\n- **Returns**: Followers who the authenticated user also follows\n- **Use**: Find mutual connections\n\n### `app.bsky.graph.getRelationships` - Relationship status\n- **Parameters**: `actor`, `others[]`\n- **Returns**: Relationship status between actor and others\n- **Use**: Efficient batch relationship checking\n\n## Domain Model Design\n\n### New `Follow` class\n```typescript\ninterface Follow {\n  subject: Did;      // The account being followed\n  follower: Did;     // The account doing the following\n  createdAt: Date;   // When the follow was created\n  uri: AtUri;        // The AT Protocol URI for this follow record\n}\n```\n\n### `FollowEvent` discriminated union\n```typescript\ntype FollowEvent =\n  | { _tag: \"FollowCreated\"; follow: Follow }\n  | { _tag: \"FollowDeleted\"; follower: Did; subject: Did; deletedAt: Date }\n```\n\n### Relationship Snapshot\n```typescript\ninterface FollowSnapshot {\n  actor: Did;\n  follows: Did[];      // Who this actor follows\n  followers: Did[];    // Who follows this actor\n  capturedAt: Date;\n}\n```\n\n## Storage Design\n\n### Directory Structure\n```\ngraph/\n├── follows/{did}/        # Who this DID follows (outgoing edges)\n│   └── snapshot.json     # List of followed DIDs with metadata\n├── followers/{did}/      # Who follows this DID (incoming edges)\n│   └── snapshot.json     # List of follower DIDs with metadata\n└── edges/{follower}/{subject}  # Individual relationship records\n    └── edge.json         # Single follow relationship with full data\n```\n\n### Storage Considerations\n- Store by subject: `graph/follows/{did}` - Quick lookup of who a DID follows\n- Store by follower: `graph/followers/{did}` - Quick lookup of followers\n- Edge storage: `graph/edges/{follower}/{subject}` - Individual relationships for detailed queries\n- Support snapshots for change tracking (diff between snapshots)\n\n## CLI Integration\n\n### Sync Commands\n```bash\n# Fetch who a handle follows (outgoing edges)\nsync follows \u003chandle\u003e\n\n# Fetch who follows a handle (incoming edges)\nsync followers \u003chandle\u003e\n\n# Fetch both directions (full graph for account)\nsync graph \u003chandle\u003e\n```\n\n### Query Commands\n```bash\n# Query stored follows (offline)\nquery follows \u003chandle\u003e\n\n# Query stored followers (offline)\nquery followers \u003chandle\u003e\n\n# Check mutual follows between two accounts\nquery mutuals \u003chandle1\u003e \u003chandle2\u003e\n```\n\n## Technical Considerations\n\n### Pagination\n- Large accounts may have millions of followers\n- Must handle pagination correctly with cursor management\n- Consider parallel fetching for large graphs\n\n### Rate Limiting\n- Graph traversal can trigger many API calls\n- Implement exponential backoff\n- Add `--rate-limit` option to control request rate\n- Consider daily/hourly sync limits\n\n### Incremental Sync\n- Store last sync timestamp per account\n- Only fetch changes since last snapshot when possible\n- Diff snapshots to detect follows/unfollows\n\n### Efficient Membership Checks\n- Consider bloom filters for \"does X follow Y?\" queries on large datasets\n- Index by both follower and subject for bidirectional lookups\n- Cache frequently accessed relationships\n\n### Storage Efficiency\n- For accounts with many followers, consider:\n  - Chunked storage (split large lists)\n  - Compressed storage for snapshot data\n  - Only store DIDs, resolve profiles on demand\n\n## Acceptance Criteria\n\n- [ ] Follow domain model created with proper Effect Schema definitions\n- [ ] FollowStore service implemented following existing store patterns\n- [ ] `sync follows \u003chandle\u003e` fetches and stores outgoing follows\n- [ ] `sync followers \u003chandle\u003e` fetches and stores incoming followers\n- [ ] Graph indexes work (by-subject lookup, by-follower lookup)\n- [ ] `query follows \u003chandle\u003e` displays stored follows offline\n- [ ] `query followers \u003chandle\u003e` displays stored followers offline\n- [ ] Change tracking possible (compare snapshots to detect new follows/unfollows)\n- [ ] Pagination handled correctly for large accounts\n- [ ] Rate limiting prevents API abuse","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-27T10:42:06.454124-06:00","updated_at":"2026-01-27T10:42:33.378934-06:00"}
{"id":"skygent-bsky-md5","title":"Add Profile store with dedicated domain model and storage","description":"## Background\n\nThe current system only stores Posts, with profile information embedded within post records. This means:\n\n- **No independent profile storage** - Profile data is duplicated across posts\n- **No profile querying** - Cannot search or filter by profile attributes\n- **No change tracking** - Cannot detect handle changes, bio updates, or follower growth\n- **Limited analytics** - Cannot analyze authors independently of their posts\n\n### Use Cases\n\n1. **Author Discovery** - Find interesting authors by follower count, post frequency, or bio keywords\n2. **Profile Change Tracking** - Monitor handle changes, bio updates, avatar changes\n3. **Follower Analytics** - Track follower/following growth over time\n4. **Network Analysis** - Build social graphs based on stored profiles\n\n---\n\n## Bluesky API Reference\n\n### `app.bsky.actor.getProfile`\nFetches a single profile with full details including stats.\n\n**Request:** `GET /xrpc/app.bsky.actor.getProfile?actor={handle|did}`\n\n### `app.bsky.actor.getProfiles`\nBatch fetch up to 25 profiles at once.\n\n**Request:** `GET /xrpc/app.bsky.actor.getProfiles?actors[]={handle1}\u0026actors[]={handle2}`\n\n### ProfileViewDetailed Schema\n\n```typescript\ninterface ProfileViewDetailed {\n  did: string                    // User's DID\n  handle: string                 // Current handle\n  displayName?: string           // Display name\n  description?: string           // Bio/description\n  avatar?: string                // Avatar URL\n  banner?: string                // Banner image URL\n  followersCount?: number        // Follower count\n  followsCount?: number          // Following count\n  postsCount?: number            // Total posts\n  associated?: {\n    lists: number                // Created lists\n    feedgens: number             // Created feeds\n    labeler: boolean             // Is a labeler\n    chat?: { allowIncoming: string }\n  }\n  labels?: Label[]               // Applied labels\n  pinnedPost?: StrongRef         // Pinned post reference\n  createdAt?: string             // Account creation date\n  verification?: Verification    // Verification status\n}\n```\n\n---\n\n## Domain Model Design\n\n### New File: `src/domain/profile.ts`\n\n```typescript\nimport { Schema } from \"effect\"\n\nexport class Profile extends Schema.Class\u003cProfile\u003e(\"Profile\")({\n  // Identity\n  did: Schema.String,\n  handle: Schema.String,\n  \n  // Display\n  displayName: Schema.OptionFromNullOr(Schema.String),\n  description: Schema.OptionFromNullOr(Schema.String),\n  avatar: Schema.OptionFromNullOr(Schema.String),\n  banner: Schema.OptionFromNullOr(Schema.String),\n  \n  // Stats\n  followersCount: Schema.Number,\n  followsCount: Schema.Number,\n  postsCount: Schema.Number,\n  \n  // Metadata\n  labels: Schema.Array(Schema.String),\n  verification: Schema.OptionFromNullOr(Schema.Struct({\n    verified: Schema.Boolean,\n    trustedVerifiers: Schema.Array(Schema.String)\n  })),\n  \n  // Timestamps\n  createdAt: Schema.OptionFromNullOr(Schema.DateFromString),\n  indexedAt: Schema.DateFromString,\n  \n  // History tracking\n  previousHandles: Schema.Array(Schema.String),\n  profileUpdatedAt: Schema.DateFromString\n}) {}\n```\n\n### Key Design Decisions\n\n1. **DID as primary key** - DIDs are permanent, handles can change\n2. **Track previous handles** - Enables handle change detection\n3. **Separate indexedAt from profileUpdatedAt** - Know when we fetched vs when profile changed\n4. **Labels as string array** - Simplified from full label objects for querying\n\n---\n\n## Storage Design\n\n### Store Namespace Structure\n\n```\nprofiles/\n├── by-did/\n│   └── {did}                    # Primary storage\n├── by-handle/\n│   └── {handle}                 # Index pointing to DID\n└── events/\n    └── {timestamp}-{did}        # Event log for changes\n```\n\n### ProfileStore Service\n\n```typescript\ninterface ProfileStore {\n  // Core operations\n  upsert(profile: Profile): Effect\u003cvoid, StoreError\u003e\n  getByDid(did: string): Effect\u003cOption\u003cProfile\u003e, StoreError\u003e\n  getByHandle(handle: string): Effect\u003cOption\u003cProfile\u003e, StoreError\u003e\n  \n  // Batch operations\n  upsertMany(profiles: Profile[]): Effect\u003cvoid, StoreError\u003e\n  getByDids(dids: string[]): Effect\u003cProfile[], StoreError\u003e\n  \n  // Query\n  query(filter: ProfileFilter): Effect\u003cProfile[], StoreError\u003e\n  \n  // Events\n  getEvents(since?: Date): Effect\u003cProfileEvent[], StoreError\u003e\n}\n```\n\n### Event Types\n\n```typescript\ntype ProfileEvent = \n  | { type: \"ProfileUpsert\"; profile: Profile; previousVersion?: Profile }\n  | { type: \"ProfileDelete\"; did: string; reason: string }\n  | { type: \"HandleChange\"; did: string; oldHandle: string; newHandle: string }\n```\n\n---\n\n## CLI Integration\n\n### New Commands\n\n```bash\n# Fetch and store single profile\nskygent sync profile alice.bsky.social\n\n# Batch fetch multiple profiles\nskygent sync profiles alice.bsky.social bob.bsky.social carol.bsky.social\n\n# Query stored profiles\nskygent query profiles --filter \"followersCount \u003e 1000\"\nskygent query profiles --filter \"handle contains '.bsky.social'\"\nskygent query profiles --filter \"labels includes 'impersonation'\"\n\n# List stored profiles\nskygent store profiles list\nskygent store profiles list --sort followersCount --limit 10\n\n# Show profile details\nskygent store profiles show did:plc:xyz123\n\n# Profile stats\nskygent store profiles stats\n```\n\n### Example Output\n\n```\n$ skygent sync profile alice.bsky.social\n\nFetching profile: alice.bsky.social\n✓ Stored profile: did:plc:abc123\n  Handle: alice.bsky.social\n  Display: Alice\n  Followers: 1,234 | Following: 567 | Posts: 890\n  Indexed: 2024-01-15T10:30:00Z\n\n$ skygent query profiles --filter \"followersCount \u003e 1000\" --output compact\n\ndid:plc:abc123  alice.bsky.social    Alice       1234/567/890\ndid:plc:def456  bob.bsky.social      Bob         5678/123/456\n```\n\n---\n\n## Acceptance Criteria\n\n- [ ] **Domain Model** - `Profile` class created in `src/domain/profile.ts`\n- [ ] **ProfileStore Service** - Implements upsert, get, query operations\n- [ ] **Handle Index** - Secondary index by handle works correctly\n- [ ] **Handle Change Detection** - Previous handles tracked when handle changes\n- [ ] **sync profile Command** - Fetches and stores single profile\n- [ ] **sync profiles Command** - Batch fetches multiple profiles\n- [ ] **query profiles Command** - Supports filtering with DSL\n- [ ] **store profiles list Command** - Lists stored profiles\n- [ ] **Event Logging** - ProfileUpsert events logged for change tracking\n- [ ] **Tests** - Unit tests for Profile model and ProfileStore\n\n---\n\n## Implementation Notes\n\n### Relation to Post Store\n\nThe Profile store should be independent but complementary to the Post store:\n- Posts continue to embed author info for denormalized access\n- Profile store provides canonical profile data\n- Future: Link posts to profiles via DID for enriched queries\n\n### Future Extensions\n\n- Profile diff/history view\n- Follower growth charts\n- Handle change notifications\n- Profile sync from Jetstream events","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-27T10:42:06.483192-06:00","updated_at":"2026-01-27T10:44:07.653752-06:00"}
{"id":"skygent-bsky-mxa","title":"Add store analytics command with time-bucketed metrics","description":"store analytics command with temporal bucketing, engagement distribution, author influence. See GitHub issue.","status":"open","priority":2,"issue_type":"feature","created_at":"2026-02-01T12:24:17.33147-06:00","updated_at":"2026-02-01T12:24:17.33147-06:00"}
{"id":"skygent-bsky-n3e","title":"CR-11: StoreIndex.query should stream with pagination","description":"","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-28T13:10:48.643344-06:00","updated_at":"2026-01-28T15:47:06.42135-06:00","closed_at":"2026-01-28T15:47:06.42135-06:00","close_reason":"Implemented: paginated query streaming and batched rebuild transactions"}
{"id":"skygent-bsky-nag","title":"Index image count and alt text for filtering","description":"## Problem\nImages are stored in the post_json blob but only tracked as boolean has_images/has_video columns. Agents and users can't filter by image count or search alt text content.\n\n## Current State\n- EmbedImages, EmbedVideo, EmbedExternal types fully modeled in domain (src/domain/bsky.ts)\n- Boolean indexed columns: has_images, has_video, has_links, has_media, has_embed\n- Filter DSL supports: has:images, has:video, has:media, has:links, has:embed\n- Full embed data preserved in post_json blob\n- No way to query image count or alt text without parsing JSON\n\n## Proposed Changes\n\n### Database\n- Add image_count INTEGER column to posts table (indexed)\n- Add alt_text TEXT column (concatenated alt texts from all images, FTS-indexed)\n- Migration extracts values from existing post_json blobs\n\n### Filter DSL\n- min-images:N — posts with at least N images\n- has:alt-text — posts where all images have alt text\n- no-alt-text — posts with images missing alt text (accessibility audit)\n- alt-text:pattern — regex/contains match on concatenated alt text\n\n### SQL Query Planner\n- image_count column enables efficient SQL-level filtering\n- alt_text FTS enables full-text search across image descriptions\n\n## Use Cases\n- Accessibility audits: find posts with images but no alt text\n- Photography feeds: filter posts with 3+ images\n- Content analysis: search alt text for specific subjects\n- Agent workflows: programmatic image content discovery","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-31T23:44:33.602578-06:00","updated_at":"2026-01-31T23:44:33.602578-06:00"}
{"id":"skygent-bsky-oft","title":"CR-24: Add tests for link-validator","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-28T13:10:47.969422-06:00","updated_at":"2026-01-28T13:10:47.969422-06:00"}
{"id":"skygent-bsky-olk","title":"CR-20: Add tests for credential-store encryption","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-28T13:10:47.356421-06:00","updated_at":"2026-01-28T13:10:47.356421-06:00"}
{"id":"skygent-bsky-px8","title":"CR-12: Batch StoreIndex rebuild transactions","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-28T13:10:48.793779-06:00","updated_at":"2026-01-28T15:49:34.662944-06:00","closed_at":"2026-01-28T15:49:34.662944-06:00","close_reason":"Duplicate of CR-12, already implemented in batched rebuild commit"}
{"id":"skygent-bsky-r0p","title":"Add bulk re-derive command for all views from a source","description":"Currently re-deriving all views from a source requires manually looping through each derived store and re-running derive with the correct filter. There should be a command like:\n\n- `skygent derive --all \u003csource\u003e` — re-derive all views from a source\n- `skygent derive --stale \u003csource\u003e` — only re-derive views that are behind the source\n\nDiscovered during testing: after syncing new posts into arsenal-feed, had to manually loop through 8 derived views to update them.","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-31T23:15:34.83633-06:00","updated_at":"2026-01-31T23:15:34.83633-06:00"}
{"id":"skygent-bsky-riq","title":"CR-09: StoreQuery.limit should use NonNegativeInt","description":"","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-28T13:10:48.299428-06:00","updated_at":"2026-01-28T15:44:28.794974-06:00","closed_at":"2026-01-28T15:44:28.794974-06:00","close_reason":"Implemented: Handle regex i-flag, NonNegativeInt limit, CLI limit validation"}
{"id":"skygent-bsky-rs7","title":"Add conversation threading and grouping to queries","description":"Group posts into conversation threads, discover high-engagement discussions, thread metrics. See GitHub issue.","status":"open","priority":2,"issue_type":"feature","created_at":"2026-02-01T12:24:29.101948-06:00","updated_at":"2026-02-01T12:24:29.101948-06:00"}
{"id":"skygent-bsky-s4f","title":"Add sync search command to ingest Bluesky network search results into a store","description":"## Summary\n\nAdd a `sync search` command that ingests Bluesky network search results directly into a store, treating search as a first-class data source alongside timeline, feed, author, thread, and jetstream.\n\n## Motivation\n\nCurrently `search posts --network` returns results to stdout but cannot persist them. To build a store from search results you'd need to manually extract URIs and sync each post individually. Search should be a composable data source like any other — you should be able to:\n\n1. Build a store from a search query\n2. Apply filters during ingestion\n3. Re-sync to pick up new results\n4. Derive views from search-sourced stores\n\nThis enables use cases like:\n- Building topic-specific stores: `sync search \"Arsenal xG\" --store arsenal-analytics`\n- Monitoring discourse: `watch search \"Arteta sacked\" --store crisis-watch`\n- Combining sources: sync a feed + search into one store for comprehensive coverage\n\n## Proposed CLI\n\n```bash\n# One-off search ingestion\nskygent sync search \"\u003cquery\u003e\" --store \u003cname\u003e [--limit \u003cn\u003e] [--sort \u003ctop|latest\u003e] [--since \u003cdate\u003e] [--until \u003cdate\u003e] [--author \u003chandle\u003e] [--lang \u003ccode\u003e] [--tag \u003ctag\u003e] [--domain \u003cdomain\u003e] [--filter \u003cdsl\u003e] [--filter-json \u003cjson\u003e] [--quiet]\n\n# Repeated polling (watch mode)\nskygent watch search \"\u003cquery\u003e\" --store \u003cname\u003e [--interval \u003cduration\u003e] [--max-cycles \u003cn\u003e] [--until \u003cduration\u003e] [--sort latest] [--filter \u003cdsl\u003e] [--quiet]\n```\n\n## Examples\n\n```bash\n# Build a store from search results\nskygent sync search \"Arsenal transfer\" --store arsenal-transfers-network --limit 500 --sort latest\n\n# Search with time bounds\nskygent sync search \"north london derby\" --store nld-chat --since 2026-01-01 --until 2026-02-01\n\n# Search + filter at ingestion\nskygent sync search \"Premier League\" --store pl-viral --limit 200 --filter 'engagement:minLikes=50'\n\n# Watch for new search results\nskygent watch search \"Arsenal signing\" --store transfer-watch --interval \"5 minutes\" --sort latest\n\n# Combine with author sync for comprehensive coverage\nskygent sync search \"Arteta tactics\" --store arsenal-tactics-wide --limit 300\nskygent sync author scott.cannonstats.com --store arsenal-tactics-wide --filter posts_no_replies\n```\n\n## Implementation notes\n\n- The Bluesky `app.bsky.feed.searchPosts` API supports cursor-based pagination, so paging logic can follow the existing sync pattern.\n- Search API params (`sort`, `since`, `until`, `author`, `lang`, `domain`, `url`, `tag`, `mentions`) should map to CLI options — most already exist on `search posts`.\n- Dedup is handled by the store's existing URI-based dedup, so mixing search results with other sources is safe.\n- For `watch search`, the `--sort latest` default makes sense to pick up new results on each poll cycle. Checkpoint could store the most recent `indexedAt` timestamp to avoid re-scanning old results.\n- The existing `search posts --network` code in `src/cli/search.ts` already handles the API call and post parsing — the sync version would reuse that pipeline and add the store ingestion step.\n\n## Related\n\n- `search posts --network` already exists but only outputs to stdout\n- All other sync sources (timeline, feed, author, thread, jetstream, list) follow the same pattern this would extend","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-31T23:33:37.999515-06:00","updated_at":"2026-01-31T23:33:37.999515-06:00"}
{"id":"skygent-bsky-tuy","title":"StoreIndex.clear fails on non-existent checkpoint file during --reset","description":"## Summary\nStoreIndex.clear fails when attempting to clear a store that has no existing checkpoint file, causing derive --reset --yes to fail.\n\n## Reproduction Steps\n1. Create a new derived store: `skygent store create test-derived`\n2. Run initial derivation: `skygent derive my-timeline test-derived --filter-json '{\"_tag\":\"All\"}'`\n3. Attempt to reset with different filter: `skygent derive my-timeline test-derived --filter-json '{\"_tag\":\"None\"}' --reset --yes`\n\n## Expected Behavior\nThe store should be cleared and re-derived with the new filter.\n\n## Actual Behavior\nCommand fails with StoreIndexError:\n\n```\nExit code: 7\nError type: StoreIndexError\nMessage: \"StoreIndex.clear failed\"\n\nCause: NotFound error when removing checkpoint file\nPath: /Users/pooks/.skygent/kv/stores%2Ftest-derived%2Fcheckpoints%2Findexes%2Fprimary\nSyscall: rm\nErrno: -2 (ENOENT)\n```\n\n## Root Cause\nIn src/services/store-index.ts:294, the clear() method calls:\n```typescript\nyield* indexes.checkpoints.remove(checkpointKey(indexName));\n```\n\nThis fails if the checkpoint file doesn't exist. The method should handle missing files gracefully since clearing a non-existent checkpoint is a valid no-op.\n\n## Suggested Fix\nWrap the checkpoint removal in Effect.ignore or catch the NotFound error:\n```typescript\nyield* Effect.ignore(indexes.checkpoints.remove(checkpointKey(indexName)));\n```\n\nOr handle all remove operations that might fail on non-existent files similarly.\n\n## Impact\n- Blocks users from resetting derived stores\n- Affects derivation workflow reliability\n- Priority 1 (high) - core feature broken","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-26T16:43:39.057981-06:00","updated_at":"2026-01-28T16:37:08.283029-06:00","closed_at":"2026-01-28T16:37:08.283029-06:00","close_reason":"StoreIndex.clear uses SQL DELETE which is no-op on empty tables"}
{"id":"skygent-bsky-uej","title":"Add last event ID tracking to StoreWriter and StoreEventLog","description":"**Plan Reference**: /Users/pooks/.claude/plans/cosmic-popping-cake.md - Phase 1, sections 1.4\n\n## Goal\nAdd O(1) last event ID tracking for efficient staleness detection. Store last EventId in KV store when events are appended.\n\n## Pre-Implementation Research\n\n### 1. Review Existing Code\n- Read src/services/store-writer.ts - understand append() implementation\n- Read src/services/store-event-log.ts - understand stream() and clear()\n- Read src/services/store-index.ts - understand KeyValueStore.prefix pattern\n- Review how EventId (ULID) is generated and stored\n\n### 2. Effect Documentation Research\nUse effect-docs MCP:\n```\neffect-docs search \"KeyValueStore\"\neffect-docs search \"Effect.gen\"\neffect-docs search \"Layer.effect\"\n```\n\nStudy:\n- KeyValueStore.prefix usage for scoped KV access\n- forSchema pattern for typed KV operations\n- Effect error handling in services\n- Layer composition patterns\n\n### 3. Review Effect Source\nCheck KeyValueStore implementation:\n- How prefix scoping works\n- Atomic write guarantees\n- Error handling patterns\n\n## Implementation\n\n### File: src/services/store-writer.ts (modify)\nAdd KV key for last event ID:\n```typescript\nconst lastEventIdKey = \"events/last-id\";\n\n// in layer setup:\nconst lastEventId = kv.forSchema(EventId);\n\n// inside append() after writing event:\nconst storeLastEventId = KeyValueStore.prefix(lastEventId, prefix);\nyield* storeEvents.set(key, record);\nyield* storeLastEventId.set(lastEventIdKey, record.id); // NEW\n```\n\n### File: src/services/store-event-log.ts (modify)\nExpose getLastEventId and clear it:\n```typescript\n// in layer setup:\nconst lastEventId = kv.forSchema(EventId);\n\nconst getLastEventId = Effect.fn(\"StoreEventLog.getLastEventId\")((store: StoreRef) =\u003e\n  KeyValueStore.prefix(lastEventId, storePrefix(store))\n    .get(lastEventIdKey)\n    .pipe(Effect.mapError(toStoreIoError(store.root)))\n);\n\n// in clear():\nyield* KeyValueStore.prefix(lastEventId, prefix).remove(lastEventIdKey);\n```\n\n## Critical Considerations\n- Writes must be atomic (KV guarantees this at key level)\n- Error handling: map KV errors to StoreIoError\n- clear() must remove last-id key to avoid stale data\n- Use Effect.fn() for proper tracing\n\n## Acceptance Criteria\n- [ ] StoreWriter.append() updates events/last-id\n- [ ] StoreEventLog.getLastEventId() returns Option\u003cEventId\u003e\n- [ ] StoreEventLog.clear() removes last-id key\n- [ ] No unsafe Effect patterns used\n- [ ] Compilation succeeds\n- [ ] Follows existing KeyValueStore patterns\n\n## Verification\n```bash\n# Manual test\nbun run src/test-last-event-id.ts\n# Should append event and retrieve last ID\n```\n\n## Related\n- Parent: #1\n- Depends on: skygent-bsky-9ed (domain types)\n- Blocks: skygent-bsky staleness detection","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-26T14:15:04.813354-06:00","updated_at":"2026-01-26T14:38:35.818193-06:00","closed_at":"2026-01-26T14:38:35.818193-06:00","close_reason":"Closed","dependencies":[{"issue_id":"skygent-bsky-uej","depends_on_id":"skygent-bsky-9ed","type":"blocks","created_at":"2026-01-26T14:22:48.89248-06:00","created_by":"daemon"}]}
{"id":"skygent-bsky-v28","title":"Graph centrality and influence metrics for stores","description":"Compute degree/betweenness/PageRank centrality on store interaction networks. Uses Effect Graph traversal APIs. See GitHub issue.","status":"open","priority":2,"issue_type":"feature","created_at":"2026-02-01T12:35:21.319804-06:00","updated_at":"2026-02-01T12:35:21.319804-06:00"}
{"id":"skygent-bsky-vdg","title":"Auto-create target stores in derive command","description":"## Goal\nAutomatically create target store if it doesn't exist during derivation, eliminating a guaranteed wasted attempt.\n\n## Problem\nCurrent behavior requires explicit store creation before derivation:\n\n```bash\n# This fails:\n$ bun run index.ts derive source target --filter-json '{\"_tag\":\"All\"}'\nError: {\"error\":{\"name\":\"target\",\"_tag\":\"StoreNotFound\"}}\n\n# Agent must figure out to run this first:\n$ bun run index.ts store create target\n$ bun run index.ts derive source target --filter-json '{\"_tag\":\"All\"}'\n```\n\n## Implementation\n\nIn src/cli/derive.ts, modify derive command handler:\n\n```typescript\nEffect.gen(function* () {\n  const engine = yield* DerivationEngine;\n  const manager = yield* StoreManager;\n  \n  // Parse and validate\n  const filterExpr = yield* parseFilter(filter);\n  const sourceRef = yield* storeOptions.loadStoreRef(source);\n  \n  // Auto-create target if it doesn't exist\n  const targetExists = yield* manager.getStore(target);\n  if (Option.isNone(targetExists)) {\n    yield* writeJson({\n      info: `Target store '${target}' does not exist, creating with default config`\n    });\n    yield* manager.createStore(target, defaultStoreConfig);\n  }\n  \n  const targetRef = yield* storeOptions.loadStoreRef(target);\n  \n  // Continue with derivation...\n})\n```\n\n## Expected Outcome\n- One-step workflow: `derive source target --filter '...'`\n- No wasted attempts learning target must exist\n- Info message informs user/agent of auto-creation\n\n## Alternative\nIf auto-creation is undesirable, improve error message:\n\n```json\n{\n  \"error\": \"StoreNotFound\",\n  \"store\": \"target\",\n  \"context\": \"target\",\n  \"message\": \"Target store 'target' does not exist\",\n  \"fix\": \"Run: bun run index.ts store create target\"\n}\n```\n\n## Priority Rationale\nP1 - Prevents 100% predictable wasted attempt for every new derivation.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-26T19:07:09.111066-06:00","updated_at":"2026-01-28T16:37:08.033061-06:00","closed_at":"2026-01-28T16:37:08.033061-06:00","close_reason":"derive.ts auto-creates target stores (line 140-147)"}
{"id":"skygent-bsky-vnx","title":"Add filter syntax examples to CLI help text","description":"## Goal\nAdd inline filter examples to --filter-json help text to prevent schema validation errors.\n\n## Context\nAgents waste tokens discovering filter syntax through trial-and-error. Schema validation errors dump 100+ lines of type information that is difficult to parse.\n\n## Implementation\nUpdate src/cli/derive.ts filterJsonOption to include examples:\n\n```typescript\nconst filterJsonOption = Options.text(\"filter-json\").pipe(\n  Options.withDescription(\n    \"Filter expression as JSON (EventTime mode supports pure filters only)\\n\" +\n    \"Examples:\\n\" +\n    \"  All posts:       '{\\\"_tag\\\":\\\"All\\\"}'\\n\" +\n    \"  By author:       '{\\\"_tag\\\":\\\"Author\\\",\\\"handle\\\":\\\"user.bsky.social\\\"}'\\n\" +\n    \"  By hashtag:      '{\\\"_tag\\\":\\\"Hashtag\\\",\\\"tag\\\":\\\"#ai\\\"}'\\n\" +\n    \"  By regex:        '{\\\"_tag\\\":\\\"Regex\\\",\\\"patterns\\\":[\\\"pattern\\\"],\\\"flags\\\":\\\"i\\\"}'\\n\" +\n    \"  Combined (AND):  '{\\\"_tag\\\":\\\"And\\\",\\\"left\\\":{...},\\\"right\\\":{...}}'\\n\" +\n    \"  Combined (OR):   '{\\\"_tag\\\":\\\"Or\\\",\\\"left\\\":{...},\\\"right\\\":{...}}'\\n\" +\n    \"  Inverted (NOT):  '{\\\"_tag\\\":\\\"Not\\\",\\\"expr\\\":{...}}'\",\n  ),\n  Options.optional\n);\n```\n\n## Expected Outcome\nAgents can see correct filter syntax at point of use, preventing 80% of schema validation errors.\n\n## Priority Rationale\nP0 - Zero-cost documentation that eliminates most common error.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-26T16:54:58.538621-06:00","updated_at":"2026-01-28T16:37:07.645287-06:00","closed_at":"2026-01-28T16:37:07.645287-06:00","close_reason":"filter-help.ts already has extensive DSL and JSON examples"}
{"id":"skygent-bsky-xib","title":"Improve schema validation error messages for agent consumption","description":"## Goal\nMake schema validation errors concise and actionable for AI agents.\n\n## Problem\nCurrent schema errors dump full union types (100+ lines), waste tokens, and don't provide clear fix guidance.\n\nExample bad error:\n```\nParseError: (parseJson \u003c-\u003e \u003csuspended schema\u003e)\n└─ Type side transformation failure\n   └─ { readonly _tag: \"All\" } | { readonly _tag: \"None\" } | ... [entire FilterExpr union]\n      └─ { readonly _tag: \"Regex\"; readonly patterns: ... }\n         └─ [\"patterns\"]\n            └─ is missing\n```\n\n## Implementation\n\n1. Create custom error formatter in src/cli/errors.ts\n2. Catch Schema.ParseError and transform to agent-friendly format:\n\n```typescript\n{\n  \"error\": \"FilterValidationError\",\n  \"message\": \"Regex filter requires 'patterns' field (array of strings)\",\n  \"received\": {\"_tag\": \"Regex\", \"pattern\": \"[Tt]rump\"},\n  \"expected\": {\"_tag\": \"Regex\", \"patterns\": [\"[Tt]rump\"], \"flags\": \"i\"},\n  \"fix\": \"Change 'pattern' to 'patterns' and wrap value in array\"\n}\n```\n\n3. Apply formatter to all CLI commands using filter-json option\n\n## Expected Outcome\n- Errors reduced from 500-1000 tokens to 100-200 tokens\n- Clear expected/received diff\n- Actionable fix suggestion\n- No verbose schema dumps\n\n## Priority Rationale\nP1 - High ROI for token savings when schema errors do occur.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-26T16:54:58.848958-06:00","updated_at":"2026-01-28T16:37:08.157984-06:00","closed_at":"2026-01-28T16:37:08.157984-06:00","close_reason":"filter-errors.ts has structured error messages with suggestions"}
{"id":"skygent-bsky-y44","title":"Render image embeds in card and terminal output","description":"## Problem\nTerminal output formats (card, table, compact) show no image information. An agent or user viewing posts in the terminal has no indication of what images are attached, their alt text, or even how many images a post contains.\n\n## Current State\n- Card format (query --format card): shows text, author, engagement — no embed info\n- Table format: no embed columns\n- ANSI rendering (view thread --ansi): no image representation\n- Full JSON is the only way to see embed data\n\n## Proposed Changes\n\n### Card Format\n- Show image count badge: [4 images]\n- Show alt text snippets (truncated) for each image\n- Show external link preview: title + domain\n- Show quote post indicator with quoted author\n- Video indicator: [video] with alt text if present\n\n### Table Format  \n- Add optional embed column: concise summary like '4img' / '1vid' / 'link:example.com' / 'quote'\n- Include in @media field preset\n\n### ANSI Thread View\n- Image placeholders with alt text: ┌─[image]─────────┐ │ Alt: sunset... │ └─────────────────┘\n- External link cards with title/domain\n- Color-coded embed type indicators\n\n### Compact Output\n- Add optional embed_type field: 'images' | 'video' | 'external' | 'record' | 'record_with_media' | null\n- Add image_count field when embed contains images\n\n## Use Cases\n- Quick post triage: see at a glance which posts have media\n- Accessibility review: check alt text quality in terminal\n- Agent consumption: structured embed metadata without full JSON parsing\n- Thread visualization: understand media context in conversations","status":"open","priority":3,"issue_type":"feature","created_at":"2026-01-31T23:44:44.361551-06:00","updated_at":"2026-01-31T23:44:44.361551-06:00"}
{"id":"skygent-bsky-yj7","title":"Add sync thread command to fetch full thread context","description":"## Background\n\n**Current limitation:** The BskyClient can fetch individual posts via `getPost(uri)` but cannot retrieve full thread context including parent chains and reply trees.\n\n**Technical gap:** The `ReplyRef` on the Post model only contains URI references (`parent` and `root`), not the full post data needed to reconstruct thread context.\n\n**Use cases:**\n- Thread analysis and conversation tracking\n- Context preservation when syncing discussions\n- Understanding reply relationships and conversation flow\n- Archiving complete conversations\n\n## Bluesky API Reference\n\n**Endpoint:** `app.bsky.feed.getPostThread`\n\n**Parameters:**\n| Parameter | Type | Required | Default | Description |\n|-----------|------|----------|---------|-------------|\n| `uri` | string | Yes | - | AT-URI of the post (e.g., `at://did:plc:xxx/app.bsky.feed.post/yyy`) |\n| `depth` | integer | No | 6 | How many reply levels to fetch (0-1000) |\n| `parentHeight` | integer | No | 80 | How many parent levels to fetch (0-1000) |\n\n**Response structure:**\n- `thread`: ThreadViewPost containing:\n  - `post`: The requested post view\n  - `parent`: Parent ThreadViewPost (recursive chain)\n  - `replies`: Array of ThreadViewPost (nested tree)\n- `threadgate`: Optional thread gate record\n\n**Note:** Some nodes in the tree may be `BlockedPost` or `NotFoundPost` instead of `ThreadViewPost`.\n\n## Implementation Scope\n\n### 1. BskyClient Extension\nAdd `getPostThread(uri, options?)` method to BskyClient:\n```typescript\ninterface GetPostThreadOptions {\n  depth?: number;       // 0-1000, default 6\n  parentHeight?: number; // 0-1000, default 80\n}\n\ngetPostThread(uri: string, options?: GetPostThreadOptions): Effect\u003cThreadViewPost, BskyError\u003e\n```\n\n### 2. DataSource Union Extension\nAdd `DataSourceThread` variant to the DataSource discriminated union in sync.ts:\n```typescript\ninterface DataSourceThread {\n  readonly _tag: \"DataSourceThread\"\n  readonly uri: string\n  readonly depth?: number\n  readonly parentHeight?: number\n}\n```\n\n### 3. Thread Flattening\nCreate utility to flatten nested thread tree into post array:\n- Traverse parent chain (recursive)\n- Traverse reply tree (recursive)\n- Collect all posts into flat array\n- Preserve original thread metadata\n\n### 4. Relationship Preservation\nEnsure all posts maintain proper ReplyRef relationships:\n- `parent`: URI of immediate parent post\n- `root`: URI of thread root post\n- These should be preserved from the original post data\n\n## CLI Integration\n\n**Commands:**\n```bash\n# Fetch thread rooted at URI (default depth=6, parentHeight=80)\nsync thread at://did:plc:xxx/app.bsky.feed.post/yyy\n\n# Control reply depth (how deep into replies)\nsync thread at://... --depth 10\n\n# Control parent height (how far up the chain)\nsync thread at://... --parent-height 5\n\n# Combine options\nsync thread at://... --depth 20 --parent-height 10\n```\n\n**Behavior:**\n- All posts in thread stored in the post store\n- Deduplication if posts already exist\n- Progress reporting during fetch\n- Summary of posts fetched/stored\n\n## Technical Considerations\n\n### Thread Response Structure\nThe thread response is nested, requiring recursive flattening:\n```\nThreadViewPost\n├── post (the requested post)\n├── parent (ThreadViewPost | BlockedPost | NotFoundPost)\n│   └── parent (recursive...)\n└── replies[]\n    ├── ThreadViewPost\n    │   └── replies[] (recursive...)\n    └── BlockedPost | NotFoundPost\n```\n\n### Error Handling\n- **BlockedPost:** User blocked, skip gracefully with log\n- **NotFoundPost:** Post deleted, skip gracefully with log\n- **Network errors:** Standard retry/fail behavior\n- **Invalid URI:** Fail with clear error message\n\n### Deduplication\nPosts may already exist in store from other sync operations:\n- Check before insert\n- Update if newer data available\n- Track stats: new vs. existing\n\n### Data Model Adapter\nNeed `toRawPostsFromThread()` similar to existing `toRawPostsFromFeed()`:\n- Handle ThreadViewPost shape differences\n- Extract embedded records consistently\n- Flatten nested structure to array\n\n## Data Model Considerations\n\n### ThreadViewPost vs FeedViewPost\n- ThreadViewPost has `parent` and `replies` fields\n- FeedViewPost has `reply` context at feed level\n- Both contain `PostView` with same core post data\n- Adapter should extract `PostView` and convert consistently\n\n### Blocked/NotFound Handling Options\n1. **Skip silently:** Just don't include in results\n2. **Log and skip:** Note in output, don't store\n3. **Placeholder:** Store marker for missing post (NOT RECOMMENDED)\n\nRecommend option 2: Log and skip.\n\n## Acceptance Criteria\n\n- [ ] `getPostThread(uri, options?)` added to BskyClient\n- [ ] Returns flattened array of posts from thread\n- [ ] Handles depth and parentHeight parameters\n- [ ] DataSourceThread added to sync.ts DataSource union\n- [ ] Thread flattening implemented with recursive traversal\n- [ ] `sync thread \u003curi\u003e` command implemented\n- [ ] `--depth` option controls reply depth (default 6)\n- [ ] `--parent-height` option controls parent chain (default 80)\n- [ ] Thread posts stored with correct ReplyRef relationships\n- [ ] BlockedPost/NotFoundPost handled gracefully with logging\n- [ ] Deduplication works with existing posts\n- [ ] Progress and summary output during sync","status":"open","priority":1,"issue_type":"feature","created_at":"2026-01-27T10:38:55.429552-06:00","updated_at":"2026-01-27T10:39:22.020756-06:00"}
